<!-- =========================
FILE: index.html
========================= -->
<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <title>PRO Trend Verification Map V2.1 â€” Offline Checklist</title>

  <!-- iOS 26 / PWA: zoom aÃ§Ä±q + safe-area -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1,
                 maximum-scale=5, user-scalable=yes,
                 viewport-fit=cover" />

  <!-- PWA / iOS -->
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="pro_icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="pro_icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="pro_icon.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <style>
    :root {
      --bg: #020617;
      --card: #0b1120;
      --card-soft: #111827;
      --accent: #fbbf24;
      --accent-soft: #6b7280;
      --danger: #f97373;
      --success: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body { height: 100%; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827, #020617);
      color: var(--text);
      padding: 8px;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
    }

    input, textarea {
      -webkit-user-select: text;
      user-select: text;
    }

    .app {
      max-width: 900px;
      margin: 0 auto 32px auto;
      padding-bottom: env(safe-area-inset-bottom);
    }

    h1 {
      font-size: 1.25rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 10px;
      line-height: 1.35;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.68rem;
      border: 1px solid #374151;
      color: var(--muted);
    }
    .pill.critical { border-color: var(--accent); color: var(--accent); }

    .btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: transparent;
      color: var(--text);
      padding: 4px 10px;
      font-size: 0.72rem;
      cursor: pointer;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn.primary {
      border-color: var(--accent);
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #020617;
      font-weight: 600;
    }

    .btn.small {
      padding: 3px 8px;
      font-size: 0.68rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.75rem;
    }

    .score-bar {
      margin-top: 2px;
      color: var(--muted);
    }

    .score-value {
      font-weight: 600;
      color: var(--accent);
    }

    .hf-flag {
      margin-left: 6px;
      font-size: 0.72rem;
    }
    .hf-ok { color: var(--success); }
    .hf-bad { color: var(--danger); }

    .mode-switch {
      display: flex;
      gap: 6px;
      margin-left: auto;
      flex-wrap: wrap;
    }

    .btn.active-mode {
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #020617;
      border-color: #fbbf24;
      font-weight: 600;
    }

    .sections {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section {
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.8));
      border-radius: 12px;
      padding: 6px 8px 7px;
      border: 1px solid #111827;
      will-change: transform;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 0.62rem;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #374151;
      color: var(--muted);
      white-space: nowrap;
    }
    .badge.critical { border-color: var(--accent); color: var(--accent); }

    .section-score {
      font-size: 0.7rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .collapse-icon {
      font-size: 0.7rem;
      color: var(--muted);
      margin-left: 4px;
      display: inline-block;
      transition: transform 120ms ease, opacity 120ms ease;
    }

    .section.collapsed .items { display: none; }
    .section.collapsed .collapse-icon { transform: rotate(-90deg); opacity: 0.7; }

    .item {
      background: var(--card);
      border-radius: 9px;
      padding: 5px 6px;
      border: 1px solid #020617;
      margin-top: 6px;
    }

    .item-title {
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 1px;
    }

    .item-desc {
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 4px;
      line-height: 1.25;
    }

    .item-actions {
      display: flex;
      gap: 3px;
      flex-wrap: nowrap;
    }

    .item-btn {
      flex: 1;
      font-size: 0.64rem;
      padding: 2px 3px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--muted);
      cursor: pointer;
      white-space: nowrap;

      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .item-btn.active-support {
      border-color: var(--success);
      background: rgba(34,197,94,0.16);
      color: #bbf7d0;
    }

    .item-btn.active-neutral {
      border-color: var(--accent-soft);
      background: rgba(107,114,128,0.22);
      color: #e5e7eb;
    }

    .item-btn.active-against {
      border-color: var(--danger);
      background: rgba(249,115,115,0.18);
      color: #fee2e2;
    }

    .item-hardfail-flag {
      font-size: 0.6rem;
      color: var(--danger);
      font-weight: 700;
      margin-left: 4px;
    }

    .final-card {
      margin-top: 10px;
      padding: 8px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, #020617, #020617);
      border: 1px solid #4b5563;
    }

    .final-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .final-score-line {
      font-size: 0.75rem;
      margin-bottom: 3px;
    }

    .final-verdict {
      font-size: 0.85rem;
      font-weight: 800;
      margin-bottom: 3px;
    }

    .final-note {
      font-size: 0.7rem;
      color: var(--muted);
      line-height: 1.3;
    }

    .export-box {
      margin-top: 7px;
      background: #020617;
      border-radius: 9px;
      border: 1px solid #111827;
      padding: 5px;
    }

    .export-label {
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .export-box textarea {
      width: 100%;
      min-height: 100px;
      border-radius: 7px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--muted);
      font-size: 0.68rem;
      padding: 6px;
      resize: vertical;
      overflow-y: auto;
      max-height: 220px;
    }

    /* Trade log */
    .trade-log-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
      margin-top: 4px;
    }

    .trade-log-inputs input,
    .trade-log-inputs select {
      flex: 1;
      min-width: 0;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--muted);
      font-size: 0.7rem;
    }

    .trade-log-list {
      margin-top: 4px;
      max-height: 180px;
      overflow-y: auto;
      border-radius: 6px;
      border: 1px solid #111827;
      padding: 4px;
      background: #020617;
      font-size: 0.68rem;
    }

    .trade-log-entry {
      padding: 3px 2px;
      border-bottom: 1px solid #111827;
      line-height: 1.25;
    }

    .trade-log-entry:last-child { border-bottom: none; }

    .trade-log-entry-header {
      font-weight: 700;
      color: var(--accent);
    }

    .trade-log-entry-meta { color: var(--muted); }

    /* Update toast */
    .update-toast {
      position: fixed;
      left: 50%;
      bottom: calc(12px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      max-width: 92%;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 6px 10px;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
      z-index: 9999;
    }

    .update-toast-text {
      font-size: 0.72rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 55vw;
    }

    .update-toast-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    @media (max-width: 600px) {
      .top-bar { flex-direction: column; align-items: flex-start; }
      .mode-switch { margin-left: 0; }
      .update-toast-text { max-width: 50vw; }
    }
  </style>
</head>

<body>
<div class="app">

  <h1>PRO Trend Verification Map â€” FULL MODE V2.1</h1>
  <div class="subtitle">
    START siqnalÄ±ndan sonra 10â€“20 saniyÉ™yÉ™ bÃ¼tÃ¼n PRO xÉ™ritÉ™ni yoxlamaq Ã¼Ã§Ã¼n offline checklist.
    V2.1: Hard-Fail sistemi, kompakt UI, collapse bÃ¶lmÉ™lÉ™r, Telegram export, LONG/SHORT REAL MODE,
    LocalStorage Trade Log, JSON Export/Import, Session Comparison V2.1, Snapshot (JSON).
  </div>

  <div class="pill-row">
    <div class="pill critical">0. QÉ™rar filteri â†’ yalnÄ±z gÃ¼clÃ¼ impulslar</div>
    <div class="pill">BÃ¶lmÉ™ 1: Futures Real Impulse (8)</div>
    <div class="pill">BÃ¶lmÉ™ 2: Spot Confirmation (4)</div>
    <div class="pill">BÃ¶lmÉ™ 3: Extra PRO (6)</div>
    <div class="pill">BÃ¶lmÉ™ 4: Market Structure (2)</div>
    <div class="pill">BÃ¶lmÉ™ 5: BTC Regime (1)</div>
  </div>

  <div class="top-bar">
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button id="btnResetAll" class="btn primary" type="button">Reset All</button>
      <button id="btnCopyExport" class="btn small" type="button">Copy Export</button>
    </div>
    <div class="score-bar">
      Overall Score: <span id="overallScore" class="score-value">0</span> / 21
      <span id="hfStatus" class="hf-flag hf-ok">Hard-Fail: Yox</span>
    </div>
    <div class="mode-switch">
      <button id="modeLong" class="btn small active-mode" type="button">LONG</button>
      <button id="modeShort" class="btn small" type="button">SHORT</button>
    </div>
  </div>

  <div class="sections" id="sectionsRoot">

    <!-- SECTION 0 -->
    <div class="section">
      <div class="section-header" role="button" aria-label="Collapse Section 0">
        <div class="section-title">
          ğŸ”µ 0. QÉ™rar Filteri
          <span class="badge critical">Ä°lk 5â€“10 saniyÉ™</span>
        </div>
        <div class="section-score"><span class="collapse-icon">â–¼</span></div>
      </div>
      <div class="items">
        <div style="font-size:0.72rem;color:var(--muted);line-height:1.35;">
          START siqnalÄ±ndan sonra Ã¶zÃ¼ndÉ™n soruÅŸ:
          <br>â€¢ Bu siqnal range iÃ§indÉ™dir, yoxsa aÃ§Ä±q impulsdadÄ±r?
          <br>â€¢ SaniyÉ™lÉ™r iÃ§indÉ™ > THRESHOLD hÉ™rÉ™kÉ™t + gÃ¼clÃ¼ volume var?
          <br>ÆgÉ™r cavab â€œbilmirÉ™mâ€dirsÉ™ â†’ hÉ™lÉ™ qÉ™rar vermÉ™, aÅŸaÄŸÄ±dakÄ± PRO xÉ™ritÉ™ni doldur.
        </div>
      </div>
    </div>

    <!-- SECTION 1 -->
    <div class="section" data-section="1">
      <div class="section-header" role="button" aria-label="Collapse Section 1">
        <div class="section-title">ğŸŸ¦ BÃ¶lmÉ™ 1 â€” Futures REAL Impulse Check
          <span class="badge critical">Æn vacib 8 punkt</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-1">0 / 8</span>
          <span class="collapse-icon">â–¼</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="1">
          <div class="item-title">1) Taker Buy/Sell Flow (Î” Taker)</div>
          <div class="item-desc">
            Bullish (LONG): Buy Ã¼stÃ¼n, yaÅŸÄ±l spike, buy > 55â€“60%.<br>
            Kritik: Price â†‘ amma buy zÉ™if â†’ fake pump riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against / Trap</button>
          </div>
        </div>

        <div class="item" data-id="2">
          <div class="item-title">2) Basis (Futures vs Spot Premium)</div>
          <div class="item-desc">
            Bullish (LONG): Basis yÃ¼ngÃ¼l â†‘, futures spotdan azca yuxarÄ±.<br>
            Kritik: Basis stabil / kÉ™skin â†‘, amma price zÉ™if â†’ manip risk.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against / Trap</button>
          </div>
        </div>

        <div class="item" data-id="3">
          <div class="item-title">3) OI / Market Cap Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Ratio stabil / yÃ¼ngÃ¼l â†‘, leverage saÄŸlamdÄ±r.<br>
            Kritik: Ratio â†“ + Price â†‘ â†’ trend yorÄŸun, late long riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="4" data-hardfail="true">
          <div class="item-title">
            4) OI Dynamics â€” 4 DavranÄ±ÅŸ
            <span class="item-hardfail-flag">HARD-FAIL</span>
          </div>
          <div class="item-desc">
            LONG konteksindÉ™:<br>
            â†‘OI + â†‘Price â†’ continuation (LONG Ã¼Ã§Ã¼n yaxÅŸÄ±)<br>
            â†‘OI + â†“Price â†’ SHORT trap qurulur, LONG Ã¼Ã§Ã¼n tÉ™hlÃ¼kÉ™lidir<br>
            â†“OI + â†‘Price â†’ squeeze son faza, late long riski<br>
            â†“OI + â†“Price â†’ trend bitir, NO-TRADE
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports Setup</button>
            <button class="item-btn" data-score="0" type="button">Mixed</button>
            <button class="item-btn" data-score="-1" type="button">Trap / NO-TRADE</button>
          </div>
        </div>

        <div class="item" data-id="5">
          <div class="item-title">5) Notional OI</div>
          <div class="item-desc">
            Bullish (LONG): Notional + Price birlikdÉ™ â†‘ â†’ real capital daxil olur.<br>
            Kritik: Notional stabil / â†“, amma Price â†‘ â†’ retail-only pump.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="6">
          <div class="item-title">6) Top Trader Account Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Retail short-heavy, pros long tÉ™rÉ™fdÉ™.<br>
            Kritik: Retail hamÄ±sÄ± long â†’ FOMO, LONG Ã¼Ã§Ã¼n riskli zona.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad / Crowded</button>
          </div>
        </div>

        <div class="item" data-id="7">
          <div class="item-title">7) Top Trader Position Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Pros sÉ™nin tÉ™rÉ™fdÉ™ (long bias).<br>
            ZiddiyyÉ™t varsa â€” ehtiyat, position sizing-i kiÃ§ilt.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Pros with me</button>
            <button class="item-btn" data-score="0" type="button">Mixed</button>
            <button class="item-btn" data-score="-1" type="button">Opposite</button>
          </div>
        </div>

        <div class="item" data-id="8">
          <div class="item-title">8) Global Long/Short Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Global > 1, amma ekstremal olmadan.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): Global Ã§ox yÃ¼ksÉ™kdirsÉ™ (crowded longs) â†’ risk.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 2 -->
    <div class="section" data-section="2">
      <div class="section-header" role="button" aria-label="Collapse Section 2">
        <div class="section-title">
          ğŸŸ© BÃ¶lmÉ™ 2 â€” Spot Confirmation (4 blok)
          <span class="badge">Trend davamÄ±</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-2">0 / 4</span>
          <span class="collapse-icon">â–¼</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="9">
          <div class="item-title">BLOCK 1 â€” Spot Money Flow</div>
          <div class="item-desc">
            LONG: Net inflow, real buy walls, yuxarÄ±ya doÄŸru axÄ±n.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): Net outflow, sell walls â†’ pump dayanÄ±qsÄ±zdÄ±r.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="10">
          <div class="item-title">BLOCK 2 â€” Spot Volume</div>
          <div class="item-desc">
            LONG: Volume â†‘ davamlÄ±, impuls arxasÄ±nda gÃ¼c var.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): Volume sÃ¶nÃ¼r â†’ continuation zÉ™iflÉ™yir.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>

        <div class="item" data-id="11">
          <div class="item-title">BLOCK 3 â€” Spot Orderbook</div>
          <div class="item-desc">
            LONG: AÅŸaÄŸÄ±da BID walls, absorption buy, alÄ±cÄ±lar dÉ™stÉ™klÉ™yir.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): YuxarÄ±da ASK walls + spoofing â†’ trap riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="12">
          <div class="item-title">BLOCK 4 â€” Spot Price Action</div>
          <div class="item-desc">
            LONG: HH/HL â†’ bullish structure, continuation Ã¼Ã§Ã¼n saÄŸlam.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): LH/LF â†’ reversal risk, LONG Ã¼Ã§Ã¼n zÉ™ifdir.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 3 -->
    <div class="section" data-section="3">
      <div class="section-header" role="button" aria-label="Collapse Section 3">
        <div class="section-title">
          ğŸŸª BÃ¶lmÉ™ 3 â€” Extra PRO Indicators
          <span class="badge">DetallÄ± analiz</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-3">0 / 6</span>
          <span class="collapse-icon">â–¼</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="13">
          <div class="item-title">1) CVD (Cumulative Volume Delta)</div>
          <div class="item-desc">
            LONG: CVD â†‘ + Price â†‘ â†’ real buy dominance.<br>
            Divergence (Price â†‘, CVD â†“) â†’ riskli continuation.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="14">
          <div class="item-title">2) Liquidation Heatmap</div>
          <div class="item-desc">
            LONG: YuxarÄ±da cluster â†’ continuation target, lakin Ã§ox yaxÄ±nsa trap ola bilÉ™r.<br>
            AÅŸaÄŸÄ±da bÃ¶yÃ¼k cluster â†’ aÅŸaÄŸÄ±ya dartma riski (LONG Ã¼Ã§Ã¼n tÉ™hlÃ¼kÉ™).
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="15">
          <div class="item-title">3) VWAP</div>
          <div class="item-desc">
            LONG: Price > VWAP vÉ™ VWAP Ã¶zÃ¼ â†‘ â†’ trend saÄŸlamdÄ±r.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): Price < VWAP vÉ™ reject â†’ LONG Ã¼Ã§Ã¼n zÉ™if zona.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="16">
          <div class="item-title">4) Tape Reading</div>
          <div class="item-desc">
            LONG: ardÄ±cÄ±l yaÅŸÄ±l high-size prints, sell-lÉ™r absorb olunur.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): qÄ±rmÄ±zÄ± high-size prints, buyer-lar geri Ã§É™kilir.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>

        <div class="item" data-id="17">
          <div class="item-title">5) Funding Curve</div>
          <div class="item-desc">
            LONG: Normal / yÃ¼ngÃ¼l pozitiv funding ok-dur.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): funding kÉ™skin â†‘ + crowded longs â†’ trap riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="18">
          <div class="item-title">6) Implied Volatility (IV)</div>
          <div class="item-desc">
            LONG: IV â†‘ + Price â†‘ â†’ trend gÃ¼clÃ¼, lakin risk-liq artÄ±r.<br>
            IV â†“ + Price â†‘ â†’ daha sakit continuation, leverage azalÄ±b.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 4 -->
    <div class="section" data-section="4">
      <div class="section-header" role="button" aria-label="Collapse Section 4">
        <div class="section-title">
          ğŸŸ¥ BÃ¶lmÉ™ 4 â€” Market Structure
          <span class="badge">4H + Local</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-4">0 / 2</span>
          <span class="collapse-icon">â–¼</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="19">
          <div class="item-title">1) 4H Macro Trend</div>
          <div class="item-desc">
            LONG: Price EMA 50/200 Ã¼stÃ¼ndÉ™ â†’ makro bullish kontekst.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): EMA-larÄ±n altÄ±nda â†’ LONG Ã¼Ã§Ã¼n É™ks trend.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="20">
          <div class="item-title">2) Local Structure</div>
          <div class="item-desc">
            LONG: BOS up, higher highs/lows â†’ continuation Ã¼Ã§Ã¼n yaxÅŸÄ±.<br>
            BOS down â†’ local trend É™ksinÉ™, LONG Ã¼Ã§Ã¼n riskli zona.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 5 -->
    <div class="section" data-section="5">
      <div class="section-header" role="button" aria-label="Collapse Section 5">
        <div class="section-title">
          ğŸŸ§ BÃ¶lmÉ™ 5 â€” BTC Regime
          <span class="badge">Altcoin Must</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-5">0 / 1</span>
          <span class="collapse-icon">â–¼</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="21" data-hardfail="true">
          <div class="item-title">
            BTC Mood (OI, VWAP, Liquidity)
            <span class="item-hardfail-flag">HARD-FAIL</span>
          </div>
          <div class="item-desc">
            LONG: BTC OI â†‘ + Price â†‘, VWAP Ã¼stÃ¼ â†’ altcoin LONG Ã¼Ã§Ã¼n saÄŸlam fon.<br>
            Bearish (LONG Ã¼Ã§Ã¼n): OI â†‘ + Price â†“ â†’ BTC-dÉ™ trap / risk rejimi, NO-TRADE.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against / NO-TRADE</button>
          </div>
        </div>
      </div>
    </div>

    <!-- FINAL CARD -->
    <div class="final-card">
      <div class="final-title">ğŸš€ Final Decision Map</div>

      <div class="final-score-line">
        Overall Score: <span id="finalScoreText" class="score-value">0 / 21</span>
      </div>

      <div id="finalVerdict" class="final-verdict">Status: No data</div>
      <div id="finalComment" class="final-note">Checklist-i doldur, nÉ™ticÉ™ burada real-time yenilÉ™nÉ™cÉ™k.</div>

      <div class="export-box">
        <div class="export-label">Telegram Ã¼Ã§Ã¼n Export:</div>
        <textarea id="exportText" readonly></textarea>
      </div>

      <!-- SNAPSHOT UI (V2.1+) -->
      <div class="export-box">
        <div class="export-label">Snapshot JSON (setup-a baÄŸlamaq Ã¼Ã§Ã¼n):</div>
        <textarea id="snapshotInput" placeholder='Buraya Snapshot JSON yapÄ±ÅŸdÄ±r (mÉ™s: {"coin":"BTCUSDT","tf":"5m","entry":...})'></textarea>
        <div style="display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;">
          <button id="btnAttachSnapshot" class="btn small" type="button">Snapshot-Ä± nÃ¶vbÉ™ti Log-a baÄŸla</button>
          <div id="snapshotStatus" style="font-size:0.68rem;color:var(--muted);align-self:center;"></div>
        </div>
      </div>

      <div class="export-box">
        <div class="export-label">Local Trade Log (yalnÄ±z bu cihazda saxlanÄ±lÄ±r):</div>
        <div class="trade-log-inputs">
          <input id="logSymbol" placeholder="Pair (mÉ™s: BTCUSDT)" />
          <input id="logTF" placeholder="TF (mÉ™s: 5m / 15m)" />
        </div>
        <button id="btnSaveTrade" class="btn small" type="button">Bu setup-Ä± Log et</button>

        <div style="display:flex;gap:4px;margin-top:4px;flex-wrap:wrap;">
          <button id="btnExportJson" class="btn small" type="button">Export JSON</button>
          <button id="btnImportJson" class="btn small" type="button">Import JSON</button>
        </div>

        <input id="importFile" type="file" accept="application/json,text/*" style="display:none" />
        <div id="tradeLogList" class="trade-log-list"></div>
      </div>

      <div class="export-box">
        <div class="export-label">Session Comparison (V2.1) â€” 2 fÉ™rqli setup-Ä± yan-yana mÃ¼qayisÉ™ et:</div>
        <div class="trade-log-inputs">
          <select id="sessionA"></select>
          <select id="sessionB"></select>
        </div>
        <button id="btnCompareSessions" class="btn small" type="button">Compare Sessions</button>
        <div id="sessionCompareResult" class="trade-log-list" style="margin-top:4px;"></div>
      </div>
    </div>

  </div>
</div>

<!-- Offline update toast -->
<div id="updateToast" class="update-toast" aria-live="polite">
  <div class="update-toast-text" id="updateToastText">Yeni versiya mÃ¶vcuddur â€” yenilÉ™mÉ™k istÉ™yirsÉ™n?</div>
  <div class="update-toast-actions">
    <button id="updateRefreshBtn" class="btn primary small" type="button">Refresh</button>
    <button id="updateDismissBtn" class="btn small" type="button">Sonra</button>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ===========================
  // CONSTANTS (LocalStorage)
  // ===========================
  const STORAGE_KEY_STATE = "proTrendV2_state";
  const STORAGE_KEY_LOG   = "proTrendV2_trades";

  const SECTION_MAX = { 1: 8, 2: 4, 3: 6, 4: 2, 5: 1 };
  const SECTION_NAME = {
    1: "Futures Impulse",
    2: "Spot Confirmation",
    3: "Extra PRO",
    4: "Market Structure",
    5: "BTC Regime"
  };

  // ===========================
  // DOM
  // ===========================
  const $ = (id) => document.getElementById(id);

  const sectionsRoot      = $("sectionsRoot");
  const overallScoreEl    = $("overallScore");
  const finalScoreTextEl  = $("finalScoreText");
  const finalVerdictEl    = $("finalVerdict");
  const finalCommentEl    = $("finalComment");
  const hfStatusEl        = $("hfStatus");
  const exportTextEl      = $("exportText");

  const btnResetAll       = $("btnResetAll");
  const btnCopyExport     = $("btnCopyExport");
  const btnSaveTrade      = $("btnSaveTrade");
  const btnExportJson     = $("btnExportJson");
  const btnImportJson     = $("btnImportJson");
  const btnCompareSessions= $("btnCompareSessions");

  const modeLongBtn       = $("modeLong");
  const modeShortBtn      = $("modeShort");

  // Snapshot
  const snapshotInput     = $("snapshotInput");
  const btnAttachSnapshot = $("btnAttachSnapshot");
  const snapshotStatus    = $("snapshotStatus");
  let pendingSnapshot = null;

  // Update toast
  const updateToast       = $("updateToast");
  const updateRefreshBtn  = $("updateRefreshBtn");
  const updateDismissBtn  = $("updateDismissBtn");
  let waitingSW = null;

  // ===========================
  // State
  // ===========================
  let currentMode = "LONG";
  const itemTexts = {}; // long base texts
  let tradeLog = [];

  let lastTotals = {
    total: 0,
    secScores: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
    hardFail: false,
    verdict: "Status: No data"
  };

  // SHORT mode texts (only overrides)
  const shortModeConfig = {
    1: { title: "1) Taker Buy/Sell Flow (Î” Taker) â€” SHORT",
      desc: "Bearish (SHORT): Sell Ã¼stÃ¼n, qÄ±rmÄ±zÄ± spike, sell > 55â€“60%.<br>Kritik: Price â†“ amma sell zÉ™if â†’ fake dump / short trap riski." },
    2: { title: "2) Basis (Futures vs Spot Premium) â€” SHORT",
      desc: "Bearish (SHORT): Basis yÃ¼ngÃ¼l â†“ vÉ™ ya mÉ™nfi, futures spotdan aÅŸaÄŸÄ±.<br>Kritik: Basis kÉ™skin â†‘ + Price â†“ â†’ crowded shorts, squeeze riski." },
    3: { title: "3) OI / Market Cap Ratio â€” SHORT",
      desc: "Bearish (SHORT): Ratio â†‘ vÉ™ Price â†“ â†’ leveraged short trend gÃ¼clÃ¼dÃ¼r.<br>Kritik: Ratio â†“ + Price â†“ â†’ trend yorÄŸun, late short riski." },
    4: { title: "4) OI Dynamics â€” 4 DavranÄ±ÅŸ (SHORT)",
      desc: "SHORT konteksindÉ™:<br>â†‘OI + â†“Price â†’ continuation (SHORT Ã¼Ã§Ã¼n yaxÅŸÄ±)<br>â†‘OI + â†‘Price â†’ short squeeze / trap riski<br>â†“OI + â†“Price â†’ son faza, daha Ã§ox profit-taking<br>â†“OI + â†‘Price â†’ squeeze, yeni short Ã¼Ã§Ã¼n Ã§ox risklidir." },
    5: { title: "5) Notional OI â€” SHORT",
      desc: "Bearish (SHORT): Notional stabil / yÃ¼ngÃ¼l â†‘, Price â†“ â†’ short tÉ™rÉ™fi aktivdir.<br>Kritik: Notional â†“ + Price â†“ â†’ de-leverage son faza, late short." },
    6: { title: "6) Top Trader Account Ratio â€” SHORT",
      desc: "SHORT: Retail long-heavydirsÉ™, pros short tÉ™rÉ™fdÉ™ â†’ Ã¼stÃ¼nlÃ¼k.<br>Kritik: Retail hamÄ±sÄ± short â†’ squeeze riski." },
    7: { title: "7) Top Trader Position Ratio â€” SHORT",
      desc: "SHORT: Pros short bias-dadÄ±rsa, setup daha etibarlÄ±dÄ±r.<br>ÆksinÉ™dirsÉ™, short Ã¼Ã§Ã¼n ehtiyat." },
    8: { title: "8) Global Long/Short Ratio â€” SHORT",
      desc: "SHORT: Global > 1 (crowded longs) â†’ short Ã¼Ã§Ã¼n rÃ¼zgar sÉ™nin tÉ™rÉ™findÉ™dir.<br>Global < 1 vÉ™ hamÄ± shortdadÄ±rsa â†’ squeeze riski." },
    9: { title: "BLOCK 1 â€” Spot Money Flow (SHORT)",
      desc: "SHORT: Net outflow, sell walls, yuxarÄ±da sell interest â†’ dump davam edÉ™ bilÉ™r.<br>Against (SHORT Ã¼Ã§Ã¼n): Net inflow + buy walls â†’ short Ã¼Ã§Ã¼n tÉ™hlÃ¼kÉ™." },
    10:{ title: "BLOCK 2 â€” Spot Volume (SHORT)",
      desc: "SHORT: AÅŸaÄŸÄ±ya doÄŸru impulsda sell volume â†‘ davamlÄ±.<br>Kritik: Volume sÃ¶nÃ¼rsÉ™, dump gÃ¼cÃ¼nÃ¼ itirir, late short riski." },
    11:{ title: "BLOCK 3 â€” Spot Orderbook (SHORT)",
      desc: "SHORT: YuxarÄ±da ASK walls, sell absorption, hÉ™r pump satÄ±lÄ±r.<br>Against: AÅŸaÄŸÄ±da gÃ¼clÃ¼ BID walls â†’ short Ã¼Ã§Ã¼n risk." },
    12:{ title: "BLOCK 4 â€” Spot Price Action (SHORT)",
      desc: "SHORT: LH/LF, lower highs/lows â†’ bearish structure, continuation Ã¼Ã§Ã¼n yaxÅŸÄ±.<br>Against: HH/HL â†’ short-a qarÅŸÄ± trend." },
    14:{ title: "2) Liquidation Heatmap (SHORT)",
      desc: "SHORT: AÅŸaÄŸÄ±da likvidation cluster-lar target kimidir, amma Ã§ox yaxÄ±nsa immediate bounce riski var.<br>YuxarÄ±dakÄ± bÃ¶yÃ¼k cluster-lar squeeze Ã¼Ã§Ã¼n maqnit ola bilÉ™r." },
    15:{ title: "3) VWAP (SHORT)",
      desc: "SHORT: Price < VWAP vÉ™ VWAP aÅŸaÄŸÄ± meyillidirsÉ™ â†’ trend short tÉ™rÉ™fdÉ™dir.<br>Against: Price > VWAP vÉ™ hÉ™r dÉ™fÉ™ Ã¼stÃ¼ndÉ™ qalÄ±rsa â†’ short Ã¼Ã§Ã¼n zÉ™ifdir." },
    17:{ title: "5) Funding Curve (SHORT)",
      desc: "SHORT: Funding Ã§ox pozitiv + crowded longs â†’ short Ã¼Ã§Ã¼n advantage.<br>Against: Funding artÄ±q negativ, amma Price hÉ™lÉ™ dÉ™ aÅŸaÄŸÄ±dÄ±rsa â†’ late short riski." },
    18:{ title: "6) Implied Volatility (IV) â€” SHORT",
      desc: "SHORT: IV Ã§ox yÃ¼ksÉ™k + Price aÅŸaÄŸÄ± â†’ qÄ±sa mÃ¼ddÉ™tlik continuation, amma agressiv squeeze riski dÉ™ artÄ±r.<br>IV dÃ¼ÅŸmÉ™yÉ™ baÅŸlayÄ±rsa â†’ artÄ±q de-risking gedir, late short ola bilÉ™r." },
    19:{ title: "1) 4H Macro Trend â€” SHORT",
      desc: "SHORT: Price EMA 50/200 altÄ±nda â†’ makro bearish kontekst, short Ã¼Ã§Ã¼n uyÄŸundur.<br>Against: EMA-larÄ±n Ã¼stÃ¼ndÉ™ â†’ short Ã¼Ã§Ã¼n É™ks trend." },
    20:{ title: "2) Local Structure â€” SHORT",
      desc: "SHORT: BOS down, lower lows/highs â†’ continuation Ã¼Ã§Ã¼n yaxÅŸÄ±.<br>BOS up â†’ short-a qarÅŸÄ± local reversal." },
    21:{ title: "BTC Mood (OI, VWAP, Liquidity) â€” SHORT",
      desc: "SHORT: BTC OI â†‘ + Price â†“, VWAP altÄ±nda â†’ altcoin SHORT Ã¼Ã§Ã¼n saÄŸlam fon.<br>Against: OI â†‘ + Price â†‘ â†’ BTC-dÉ™ squeeze rejimi, NO-TRADE." }
  };

  // ===========================
  // Helpers
  // ===========================
  function sectionMax(id) { return SECTION_MAX[id] || 0; }

  function formatTimestamp(ts) {
    try {
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    } catch {
      return String(ts || "");
    }
  }

  function buildVerdict(total, hardFail) {
    if (hardFail) {
      return {
        verdict: "âŒ HARD-FAIL â€” NO TRADE",
        comment: "BTC vÉ™ ya OI Dynamics ciddi É™leyhdÉ™dir. Score yÃ¼ksÉ™k olsa belÉ™ TREYD ETMÆ. Trap riskini qÉ™bul etmÉ™."
      };
    }
    if (total >= 13) {
      return {
        verdict: "âœ… HIGH CONVICTION â€” PRO Entry",
        comment: "Futures + Spot + Extra PRO + Struktur + BTC hamÄ±sÄ± sÉ™nin tÉ™rÉ™findÉ™dir. PlanlÄ± risklÉ™ PRO Ã¶lÃ§Ã¼dÉ™ entry mÃ¼mkÃ¼ndÃ¼r."
      };
    }
    if (total >= 7) {
      return {
        verdict: "ğŸŸ¢ STRONG / OK Setup",
        comment: "Æsas bloklar alignment verir. Normal Ã¶lÃ§Ã¼dÉ™ trade edilÉ™ bilÉ™r, zÉ™if bloklarÄ± risk hesablamasÄ±nda nÉ™zÉ™rÉ™ al."
      };
    }
    if (total >= 3) {
      return {
        verdict: "ğŸŸ¡ MIXED â€” Small Size / Scout",
        comment: "BÉ™zi bloklar yaxÅŸÄ±, bÉ™zilÉ™ri É™leyhinÉ™dir. Bu daha Ã§ox scout-size vÉ™ praktik mÃ¼ÅŸahidÉ™ treydi Ã¼Ã§Ã¼ndÃ¼r."
      };
    }
    if (total >= 0) {
      return {
        verdict: "ğŸŸ§ WEAK â€” NO-TRADE Zone",
        comment: "Alignment Ã§ox zÉ™ifdir. Daha tÉ™miz impuls vÉ™ daha gÃ¼clÃ¼ tÉ™sdiq Ã¼Ã§Ã¼n sÉ™br etmÉ™k uzun mÃ¼ddÉ™tdÉ™ daha sÉ™rfÉ™lidir."
      };
    }
    return {
      verdict: "ğŸ”´ CONTRARIAN ONLY",
      comment: "Ãœmumi skor mÉ™nfidir. Bu yalnÄ±z Ã§ox tÉ™crÃ¼bÉ™li kontrarian scalp Ã¼Ã§Ã¼n mÉ™ntiqlidir, normal treyd Ã¼Ã§Ã¼n uyÄŸun deyil."
    };
  }

  function buildExport(secScores, total, verdict, hardFail) {
    let text = "";
    text += "ğŸ“Œ PRO Trend Verification â€” FULL MODE V2.1\n";
    text += `Mode: ${currentMode}\n`;
    text += "----------------------------------------\n";
    text += `ğŸŸ¦ Futures Impulse: ${secScores[1]} / 8\n`;
    text += `ğŸŸ© Spot Confirmation: ${secScores[2]} / 4\n`;
    text += `ğŸŸª Extra PRO: ${secScores[3]} / 6\n`;
    text += `ğŸŸ¥ Market Structure: ${secScores[4]} / 2\n`;
    text += `ğŸŸ§ BTC Regime: ${secScores[5]} / 1\n\n`;
    text += `ğŸ“Š Overall Score: ${total} / 21\n`;
    text += `âš™ï¸ Hard-Fail: ${hardFail ? "VAR (NO-TRADE)" : "Yox"}\n`;
    text += `ğŸ§¾ Verdict: ${verdict}\n`;
    exportTextEl.value = text;
  }

  // ===========================
  // Snapshot
  // ===========================
  function safeParseSnapshot(text) {
    try {
      const obj = JSON.parse(text);
      if (!obj || typeof obj !== "object") return null;
      return obj;
    } catch {
      return null;
    }
  }

  function attachSnapshot() {
    const raw = (snapshotInput?.value || "").trim();
    if (!raw) { alert("Snapshot JSON boÅŸdur."); return; }

    const parsed = safeParseSnapshot(raw);
    if (!parsed) { alert("Snapshot JSON formatÄ± dÃ¼zgÃ¼n deyil."); return; }

    pendingSnapshot = {
      attachedAt: new Date().toISOString(),
      data: parsed,
      raw
    };

    if (snapshotStatus) {
      snapshotStatus.textContent = "Snapshot nÃ¶vbÉ™ti trade Ã¼Ã§Ã¼n hazÄ±rdÄ±r âœ”";
      snapshotStatus.style.color = "var(--accent)";
    }
  }

  // ===========================
  // Mode text system
  // ===========================
  function initModeTexts() {
    document.querySelectorAll(".item").forEach((item) => {
      const id = item.dataset.id;
      if (!id) return;
      const tEl = item.querySelector(".item-title");
      const dEl = item.querySelector(".item-desc");
      if (!tEl || !dEl) return;
      if (!itemTexts[id]) {
        itemTexts[id] = { titleLong: tEl.innerHTML, descLong: dEl.innerHTML };
      }
    });
  }

  function applyModeToItems() {
    document.querySelectorAll(".item").forEach((item) => {
      const id = item.dataset.id;
      if (!id) return;
      const tEl = item.querySelector(".item-title");
      const dEl = item.querySelector(".item-desc");
      if (!tEl || !dEl) return;

      const base = itemTexts[id];
      if (currentMode === "LONG") {
        if (base) { tEl.innerHTML = base.titleLong; dEl.innerHTML = base.descLong; }
      } else {
        const cfg = shortModeConfig[id] || {};
        tEl.innerHTML = cfg.title || (base && base.titleLong) || tEl.innerHTML;
        dEl.innerHTML = cfg.desc || (base && base.descLong) || dEl.innerHTML;
      }
    });
  }

  function setMode(mode) {
    currentMode = (mode === "SHORT") ? "SHORT" : "LONG";
    modeLongBtn.classList.toggle("active-mode", currentMode === "LONG");
    modeShortBtn.classList.toggle("active-mode", currentMode === "SHORT");
    applyModeToItems();
    recompute();
    saveStateToStorage();
  }

  // ===========================
  // Scoring logic (delegated)
  // ===========================
  function setScoreForItem(itemEl, score) {
    if (!itemEl) return;
    itemEl.dataset.score = String(score);

    const buttons = itemEl.querySelectorAll(".item-btn");
    buttons.forEach((b) => b.classList.remove("active-support", "active-neutral", "active-against"));

    const pressed = itemEl.querySelector(`.item-btn[data-score="${score}"]`);
    if (score === 1 && pressed) pressed.classList.add("active-support");
    else if (score === 0 && pressed) pressed.classList.add("active-neutral");
    else if (score === -1 && pressed) pressed.classList.add("active-against");

    recompute();
    saveStateToStorage();
  }

  function recompute() {
    const secScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let hardFail = false;

    document.querySelectorAll(".section[data-section]").forEach((sec) => {
      const sid = parseInt(sec.dataset.section || "0", 10);
      if (!sid) return;

      let sum = 0;
      sec.querySelectorAll(".item").forEach((item) => {
        const s = parseInt(item.dataset.score || "0", 10);
        sum += s;
        if (item.dataset.hardfail === "true" && s === -1) hardFail = true;
      });

      const max = sectionMax(sid);
      const clamped = Math.max(0, Math.min(max, sum));
      secScores[sid] = clamped;
    });

    const total = secScores[1] + secScores[2] + secScores[3] + secScores[4] + secScores[5];

    for (let i = 1; i <= 5; i++) {
      const el = $("score-sec-" + i);
      if (el) el.textContent = `${secScores[i]} / ${SECTION_MAX[i]}`;
    }

    const v = buildVerdict(total, hardFail);

    lastTotals = {
      total,
      secScores: { ...secScores },
      hardFail,
      verdict: v.verdict
    };

    overallScoreEl.textContent = String(total);
    finalScoreTextEl.textContent = `${total} / 21`;
    finalVerdictEl.textContent = v.verdict;
    finalCommentEl.textContent = v.comment;

    hfStatusEl.textContent = `Hard-Fail: ${hardFail ? "VAR (NO-TRADE)" : "Yox"}`;
    hfStatusEl.classList.toggle("hf-ok", !hardFail);
    hfStatusEl.classList.toggle("hf-bad", hardFail);

    buildExport(secScores, total, v.verdict, hardFail);
  }

  // ===========================
  // LocalStorage state
  // ===========================
  function saveStateToStorage() {
    try {
      const scores = {};
      document.querySelectorAll(".item").forEach((item) => {
        const id = item.dataset.id;
        if (!id) return;
        scores[id] = parseInt(item.dataset.score || "0", 10);
      });
      const payload = { version: 1, mode: currentMode, scores };
      localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(payload));
    } catch {}
  }

  function loadStateFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_STATE);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch {
      return null;
    }
  }

  function applySavedScores(scores) {
    if (!scores) return;
    document.querySelectorAll(".item").forEach((item) => {
      const id = item.dataset.id;
      if (!id) return;
      if (!(id in scores)) return;

      const s = parseInt(scores[id], 10);
      item.dataset.score = String(s);

      const buttons = item.querySelectorAll(".item-btn");
      buttons.forEach((b) => b.classList.remove("active-support", "active-neutral", "active-against"));

      const pressed = item.querySelector(`.item-btn[data-score="${s}"]`);
      if (s === 1 && pressed) pressed.classList.add("active-support");
      else if (s === 0 && pressed) pressed.classList.add("active-neutral");
      else if (s === -1 && pressed) pressed.classList.add("active-against");
    });
  }

  // ===========================
  // Reset & Copy
  // ===========================
  function resetAll() {
    document.querySelectorAll(".item").forEach((item) => {
      delete item.dataset.score;
      const buttons = item.querySelectorAll(".item-btn");
      buttons.forEach((b) => b.classList.remove("active-support", "active-neutral", "active-against"));
    });
    recompute();
    saveStateToStorage();
  }

  async function copyExport() {
    try {
      const txt = exportTextEl.value || "";
      if (!txt.trim()) { alert("Export boÅŸdur."); return; }

      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(txt);
      } else {
        exportTextEl.focus();
        exportTextEl.select();
        document.execCommand("copy");
      }
      alert("Export kopyalandÄ± âœ”");
    } catch {
      alert("Copy alÄ±nmadÄ±. (iOS/PWA icazÉ™ mÉ™hdudiyyÉ™ti ola bilÉ™r)");
    }
  }

  // ===========================
  // Trade log
  // ===========================
  function saveTradeLogToStorage() {
    try { localStorage.setItem(STORAGE_KEY_LOG, JSON.stringify(tradeLog)); } catch {}
  }

  function loadTradeLog() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_LOG);
      tradeLog = raw ? (JSON.parse(raw) || []) : [];
    } catch {
      tradeLog = [];
    }
    renderTradeLog();
    updateSessionSelectors();
  }

  function renderTradeLog() {
    const box = $("tradeLogList");
    if (!box) return;

    if (!tradeLog.length) {
      box.innerHTML = '<div style="color: var(--muted); font-size:0.68rem;">HÉ™lÉ™ heÃ§ bir trade yoxdur.</div>';
      return;
    }

    let html = "";
    tradeLog.slice().reverse().forEach((entry) => {
      const hasSnap = !!entry.snapshot;
      html += `<div class="trade-log-entry">
        <div class="trade-log-entry-header">[${formatTimestamp(entry.ts)}] ${entry.symbol || "N/A"} ${entry.tf ? "(" + entry.tf + ")" : ""}</div>
        <div class="trade-log-entry-meta">Mode: ${entry.mode} â€” Score: ${entry.totalScore ?? 0}/21 â€” HardFail: ${entry.hardFail ? "VAR" : "Yox"}</div>
        <div class="trade-log-entry-meta">Verdict: ${entry.verdict || "-"}</div>
        ${hasSnap ? `<details style="margin-top:4px;">
          <summary style="cursor:pointer;color:var(--accent);font-size:0.65rem;">ğŸ“¦ Snapshot (click)</summary>
          <pre style="white-space:pre-wrap;font-size:0.62rem;color:var(--muted);margin-top:4px;">${JSON.stringify(entry.snapshot.data, null, 2)}</pre>
        </details>` : ""}
      </div>`;
    });

    box.innerHTML = html;
  }

  function saveTradeLog() {
    const symbol = ($("logSymbol").value || "").trim();
    const tf = ($("logTF").value || "").trim();

    if (!symbol) { alert("Trade log Ã¼Ã§Ã¼n É™n azÄ± pair (mÉ™s: BTCUSDT) yaz."); return; }

    const anyScored = !!document.querySelector(".item[data-score]");
    if (!anyScored) { alert("ÆvvÉ™lcÉ™ checklist-dÉ™n É™n azÄ± bir neÃ§É™ punkt iÅŸarÉ™lÉ™, sonra log et."); return; }

    const entry = {
      ts: new Date().toISOString(),
      mode: currentMode,
      symbol,
      tf,
      totalScore: lastTotals.total,
      secScores: { ...lastTotals.secScores },
      hardFail: lastTotals.hardFail,
      verdict: lastTotals.verdict,
      snapshot: pendingSnapshot ? pendingSnapshot : null
    };

    tradeLog.push(entry);
    if (tradeLog.length > 200) tradeLog = tradeLog.slice(tradeLog.length - 200);

    // reset snapshot after save
    pendingSnapshot = null;
    if (snapshotInput) snapshotInput.value = "";
    if (snapshotStatus) snapshotStatus.textContent = "";

    saveTradeLogToStorage();
    renderTradeLog();
    updateSessionSelectors();

    $("logTF").value = "";
  }

  // ===========================
  // JSON export/import (Snapshot-aware)
  // ===========================
  function exportJournalJson() {
    try {
      const scores = {};
      document.querySelectorAll(".item").forEach((item) => {
        const id = item.dataset.id;
        if (!id) return;
        scores[id] = parseInt(item.dataset.score || "0", 10);
      });

      const payload = {
        version: "2.1-snapshot",
        exportedAt: new Date().toISOString(),
        mode: currentMode,
        totals: lastTotals,
        scores,
        tradeLog: tradeLog || []
      };

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");

      a.href = url;
      a.download = `pro_trend_journal_snapshot_${y}${m}${d}_${hh}${mm}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
      alert("Snapshot-lÄ± Journal JSON export olundu âœ”");
    } catch {
      alert("Export zamanÄ± xÉ™ta baÅŸ verdi.");
    }
  }

  function importJournalJson() {
    const fileInput = $("importFile");
    if (!fileInput) return;

    fileInput.value = "";
    fileInput.onchange = (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data || typeof data !== "object") throw new Error("Bad JSON");

          if (data.mode === "SHORT" || data.mode === "LONG") setMode(data.mode);
          if (data.scores && typeof data.scores === "object") applySavedScores(data.scores);

          if (Array.isArray(data.tradeLog)) {
            tradeLog = data.tradeLog;
            saveTradeLogToStorage();
          }

          recompute();
          saveStateToStorage();
          renderTradeLog();
          updateSessionSelectors();

          alert("Snapshot-lÄ± Journal JSON import olundu âœ”");
        } catch (err) {
          console.error(err);
          alert("JSON faylÄ± dÃ¼zgÃ¼n formatda deyil.");
        }
      };
      reader.readAsText(file);
    };

    fileInput.click();
  }

  // ===========================
  // Session comparison (V2.1)
  // ===========================
  function updateSessionSelectors() {
    const selA = $("sessionA");
    const selB = $("sessionB");
    const resBox = $("sessionCompareResult");
    if (!selA || !selB || !resBox) return;

    selA.innerHTML = "";
    selB.innerHTML = "";

    if (!tradeLog.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No sessions logged";
      selA.appendChild(opt.cloneNode(true));
      selB.appendChild(opt);
      selA.disabled = true;
      selB.disabled = true;
      resBox.innerHTML = '<div style="color: var(--muted); font-size:0.68rem;">MÃ¼qayisÉ™ Ã¼Ã§Ã¼n É™vvÉ™lcÉ™ É™n azÄ± 2 trade log et.</div>';
      return;
    }

    selA.disabled = false;
    selB.disabled = false;

    tradeLog.forEach((entry, idx) => {
      const label = `[${formatTimestamp(entry.ts)}] ${entry.symbol || "N/A"} ${entry.tf ? "(" + entry.tf + ")" : ""} â€” ${entry.mode} ${entry.totalScore != null ? " | " + entry.totalScore + "/21" : ""}`;

      const optA = document.createElement("option");
      optA.value = String(idx);
      optA.textContent = label;

      const optB = document.createElement("option");
      optB.value = String(idx);
      optB.textContent = label;

      selA.appendChild(optA);
      selB.appendChild(optB);
    });

    const n = tradeLog.length;
    if (n >= 1) selB.value = String(n - 1);
    if (n >= 2) selA.value = String(n - 2);
    else selA.value = String(0);
  }

  function compareSessions() {
    const selA = $("sessionA");
    const selB = $("sessionB");
    const resBox = $("sessionCompareResult");
    if (!selA || !selB || !resBox) return;

    const idxA = parseInt(selA.value || "-1", 10);
    const idxB = parseInt(selB.value || "-1", 10);

    if (
      isNaN(idxA) || isNaN(idxB) ||
      idxA < 0 || idxB < 0 ||
      idxA >= tradeLog.length || idxB >= tradeLog.length
    ) { alert("MÃ¼qayisÉ™ Ã¼Ã§Ã¼n 2 keÃ§É™rli sessiya seÃ§."); return; }

    if (idxA === idxB) { alert("Eyni sessiyanÄ± mÃ¼qayisÉ™ etmÉ™k olmaz."); return; }

    const A = tradeLog[idxA];
    const B = tradeLog[idxB];

    const scoresA = A.secScores || {};
    const scoresB = B.secScores || {};

    let html = "";

    html += `<div class="trade-log-entry">
      <div class="trade-log-entry-header">Session A</div>
      <div class="trade-log-entry-meta">[${formatTimestamp(A.ts)}] ${A.symbol || "N/A"} ${A.tf ? "(" + A.tf + ")" : ""}</div>
      <div class="trade-log-entry-meta">Score: ${A.totalScore ?? 0}/21 â€” HardFail: ${A.hardFail ? "VAR" : "Yox"}</div>
    </div>`;

    html += `<div class="trade-log-entry">
      <div class="trade-log-entry-header">Session B</div>
      <div class="trade-log-entry-meta">[${formatTimestamp(B.ts)}] ${B.symbol || "N/A"} ${B.tf ? "(" + B.tf + ")" : ""}</div>
      <div class="trade-log-entry-meta">Score: ${B.totalScore ?? 0}/21 â€” HardFail: ${B.hardFail ? "VAR" : "Yox"}</div>
    </div>`;

    html += `<div class="trade-log-entry">
      <div class="trade-log-entry-header">Section-by-Section</div>`;

    for (let i = 1; i <= 5; i++) {
      const sa = parseInt(scoresA[i] || 0, 10);
      const sb = parseInt(scoresB[i] || 0, 10);
      const diff = sb - sa;
      const maxVal = SECTION_MAX[i] || 1;

      html += `<div class="trade-log-entry-meta">
        â€¢ ${SECTION_NAME[i]}: A ${sa}/${maxVal} â†’ B ${sb}/${maxVal} (Î” ${diff >= 0 ? "+" + diff : diff})
      </div>`;
    }

    html += `</div>`;
    resBox.innerHTML = html;
  }

  // ===========================
  // Section collapse (safe)
  // ===========================
  function initCollapse() {
    document.querySelectorAll(".section-header").forEach((h) => {
      h.addEventListener("click", (e) => {
        if (e.target.closest("button")) return;
        const sec = h.closest(".section");
        if (!sec) return;
        sec.classList.toggle("collapsed");
      });
    });

    // Default: only Section 1 open
    document.querySelectorAll(".section[data-section]").forEach((sec) => {
      const id = parseInt(sec.dataset.section || "0", 10);
      if (id > 1) sec.classList.add("collapsed");
    });
  }

  // ===========================
  // Delegated tap/click handler (iOS stable)
  // ===========================
  function initDelegatedButtons() {
    if (!sectionsRoot) return;

    const handler = (e) => {
      const btn = e.target.closest(".item-btn");
      if (!btn) return;
      const item = btn.closest(".item");
      if (!item) return;
      const score = parseInt(btn.dataset.score || "0", 10);
      setScoreForItem(item, score);
    };

    sectionsRoot.addEventListener("pointerup", handler);
    sectionsRoot.addEventListener("click", handler);
  }

  // ===========================
  // Service worker update toast
  // ===========================
  function showUpdateToast() {
    if (!updateToast) return;
    updateToast.style.display = "flex";
  }

  function hideUpdateToast() {
    if (!updateToast) return;
    updateToast.style.display = "none";
  }

  async function registerServiceWorker() {
    if (!("serviceWorker" in navigator)) return;

    try {
      const reg = await navigator.serviceWorker.register("./service-worker.js", { scope: "./" });

      if (reg.waiting) {
        waitingSW = reg.waiting;
        showUpdateToast();
      }

      reg.addEventListener("updatefound", () => {
        const newWorker = reg.installing;
        if (!newWorker) return;

        newWorker.addEventListener("statechange", () => {
          if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
            waitingSW = reg.waiting || newWorker;
            showUpdateToast();
          }
        });
      });

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        window.location.reload();
      });
    } catch {
      // sÉ™ssiz fail
    }
  }

  // ===========================
  // Wire buttons
  // ===========================
  function wireTopButtons() {
    btnResetAll?.addEventListener("click", resetAll);
    btnCopyExport?.addEventListener("click", copyExport);

    modeLongBtn?.addEventListener("click", () => setMode("LONG"));
    modeShortBtn?.addEventListener("click", () => setMode("SHORT"));

    btnSaveTrade?.addEventListener("click", saveTradeLog);
    btnExportJson?.addEventListener("click", exportJournalJson);
    btnImportJson?.addEventListener("click", importJournalJson);
    btnCompareSessions?.addEventListener("click", compareSessions);

    btnAttachSnapshot?.addEventListener("click", attachSnapshot);

    updateRefreshBtn?.addEventListener("click", () => {
      try { if (waitingSW) waitingSW.postMessage({ type: "SKIP_WAITING" }); } catch {}
      hideUpdateToast();
    });

    updateDismissBtn?.addEventListener("click", hideUpdateToast);
  }

  // ===========================
  // Boot
  // ===========================
  function boot() {
    // Guard: É™sas elementlÉ™r yoxdursa, JS-in qalanÄ± iÅŸlÉ™mÉ™sin
    if (!sectionsRoot || !overallScoreEl || !finalVerdictEl || !exportTextEl) {
      console.error("DOM elements missing. Check index.html integrity.");
      return;
    }

    initCollapse();
    initModeTexts();
    initDelegatedButtons();
    wireTopButtons();

    const state = loadStateFromStorage();
    if (state && (state.mode === "LONG" || state.mode === "SHORT")) currentMode = state.mode;

    applyModeToItems();
    if (state && state.scores) applySavedScores(state.scores);

    loadTradeLog();

    modeLongBtn.classList.toggle("active-mode", currentMode === "LONG");
    modeShortBtn.classList.toggle("active-mode", currentMode === "SHORT");

    recompute();
    registerServiceWorker();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once: true });
  } else {
    boot();
  }
})();
</script>
</body>
</html>
