<!-- =========================
FILE: index.html
========================= -->
<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <title>PRO Trend Verification Map V2.1 ‚Äî Offline Checklist</title>

  <!-- iOS 26 / PWA: zoom a√ßƒ±q + safe-area -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1,
                 maximum-scale=5, user-scalable=yes,
                 viewport-fit=cover" />

  <!-- PWA / iOS -->
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="pro_icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="pro_icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="pro_icon.png">

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json">

  <style>
    :root {
      --bg: #020617;
      --card: #0b1120;
      --card-soft: #111827;
      --accent: #fbbf24;
      --accent-soft: #6b7280;
      --danger: #f97373;
      --success: #22c55e;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    html, body { height: 100%; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827, #020617);
      color: var(--text);
      padding: 8px;
      overscroll-behavior: none;
      -webkit-text-size-adjust: 100%;
    }

    /* iOS: input/textarea se√ßimi normal qalsƒ±n */
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
    }

    .app {
      max-width: 900px;
      margin: 0 auto 32px auto;
      padding-bottom: env(safe-area-inset-bottom);
    }

    h1 {
      font-size: 1.25rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 10px;
      line-height: 1.35;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.68rem;
      border: 1px solid #374151;
      color: var(--muted);
    }
    .pill.critical { border-color: var(--accent); color: var(--accent); }

    .btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: transparent;
      color: var(--text);
      padding: 4px 10px;
      font-size: 0.72rem;
      cursor: pointer;

      /* iOS 26: tap responsiv + zoom-a toxunmur (yalnƒ±z d√ºym…ôl…ôrd…ô) */
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .btn.primary {
      border-color: var(--accent);
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #020617;
      font-weight: 600;
    }

    .btn.small {
      padding: 3px 8px;
      font-size: 0.68rem;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.75rem;
    }

    .score-bar {
      margin-top: 2px;
      color: var(--muted);
    }

    .score-value {
      font-weight: 600;
      color: var(--accent);
    }

    .hf-flag {
      margin-left: 6px;
      font-size: 0.72rem;
    }
    .hf-ok { color: var(--success); }
    .hf-bad { color: var(--danger); }

    .mode-switch {
      display: flex;
      gap: 6px;
      margin-left: auto;
      flex-wrap: wrap;
    }

    .btn.active-mode {
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #020617;
      border-color: #fbbf24;
      font-weight: 600;
    }

    .sections {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section {
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,0.8));
      border-radius: 12px;
      padding: 6px 8px 7px;
      border: 1px solid #111827;
      will-change: transform;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 0.62rem;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #374151;
      color: var(--muted);
      white-space: nowrap;
    }
    .badge.critical { border-color: var(--accent); color: var(--accent); }

    .section-score {
      font-size: 0.7rem;
      color: var(--muted);
      white-space: nowrap;
    }

    .collapse-icon {
      font-size: 0.7rem;
      color: var(--muted);
      margin-left: 4px;
      display: inline-block;
      transition: transform 120ms ease, opacity 120ms ease;
    }

    .section.collapsed .items { display: none; }
    .section.collapsed .collapse-icon { transform: rotate(-90deg); opacity: 0.7; }

    .item {
      background: var(--card);
      border-radius: 9px;
      padding: 5px 6px;
      border: 1px solid #020617;
      margin-top: 6px;
    }

    .item-title {
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 1px;
    }

    .item-desc {
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 4px;
      line-height: 1.25;
    }

    .item-actions {
      display: flex;
      gap: 3px;
      flex-wrap: nowrap;
    }

    .item-btn {
      flex: 1;
      font-size: 0.64rem;
      padding: 2px 3px;
      border-radius: 999px;
      border: 1px solid #374151;
      background: #020617;
      color: var(--muted);
      cursor: pointer;
      white-space: nowrap;

      /* iOS 26 tap stabilliyi */
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .item-btn.active-support {
      border-color: var(--success);
      background: rgba(34,197,94,0.16);
      color: #bbf7d0;
    }

    .item-btn.active-neutral {
      border-color: var(--accent-soft);
      background: rgba(107,114,128,0.22);
      color: #e5e7eb;
    }

    .item-btn.active-against {
      border-color: var(--danger);
      background: rgba(249,115,115,0.18);
      color: #fee2e2;
    }

    .item-hardfail-flag {
      font-size: 0.6rem;
      color: var(--danger);
      font-weight: 700;
      margin-left: 4px;
    }

    .final-card {
      margin-top: 10px;
      padding: 8px;
      border-radius: 12px;
      background: radial-gradient(circle at top left, #020617, #020617);
      border: 1px solid #4b5563;
    }

    .final-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 3px;
    }

    .final-score-line {
      font-size: 0.75rem;
      margin-bottom: 3px;
    }

    .final-verdict {
      font-size: 0.85rem;
      font-weight: 800;
      margin-bottom: 3px;
    }

    .final-note {
      font-size: 0.7rem;
      color: var(--muted);
      line-height: 1.3;
    }

    .export-box {
      margin-top: 7px;
      background: #020617;
      border-radius: 9px;
      border: 1px solid #111827;
      padding: 5px;
    }

    .export-label {
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .export-box textarea {
      width: 100%;
      min-height: 100px;
      border-radius: 7px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--muted);
      font-size: 0.68rem;
      padding: 6px;
      resize: vertical;
      overflow-y: auto;
      max-height: 220px;
    }

    /* Trade log */
    .trade-log-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 4px;
      margin-top: 4px;
    }

    .trade-log-inputs input,
    .trade-log-inputs select {
      flex: 1;
      min-width: 0;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--muted);
      font-size: 0.7rem;
    }

    .trade-log-list {
      margin-top: 4px;
      max-height: 180px;
      overflow-y: auto;
      border-radius: 6px;
      border: 1px solid #111827;
      padding: 4px;
      background: #020617;
      font-size: 0.68rem;
    }

    .trade-log-entry {
      padding: 3px 2px;
      border-bottom: 1px solid #111827;
      line-height: 1.25;
    }

    .trade-log-entry:last-child { border-bottom: none; }

    .trade-log-entry-header {
      font-weight: 700;
      color: var(--accent);
    }

    .trade-log-entry-meta { color: var(--muted); }

    /* Update toast */
    .update-toast {
      position: fixed;
      left: 50%;
      bottom: calc(12px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      max-width: 92%;
      background: rgba(15, 23, 42, 0.98);
      border-radius: 999px;
      border: 1px solid #4b5563;
      padding: 6px 10px;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
      z-index: 9999;
    }

    .update-toast-text {
      font-size: 0.72rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 55vw;
    }

    .update-toast-actions {
      display: flex;
      gap: 4px;
      flex-shrink: 0;
    }

    @media (max-width: 600px) {
      .top-bar { flex-direction: column; align-items: flex-start; }
      .mode-switch { margin-left: 0; }
      .update-toast-text { max-width: 50vw; }
    }
  </style>
</head>

<body>
<div class="app">

  <h1>PRO Trend Verification Map ‚Äî FULL MODE V2.1</h1>
  <div class="subtitle">
    START siqnalƒ±ndan sonra 10‚Äì20 saniy…ôy…ô b√ºt√ºn PRO x…ôrit…ôni yoxlamaq √º√ß√ºn offline checklist.
    V2.1: Hard-Fail sistemi, kompakt UI, collapse b√∂lm…ôl…ôr, Telegram export, LONG/SHORT REAL MODE,
    LocalStorage Trade Log, JSON Export/Import, Session Comparison V2.1.
  </div>

  <div class="pill-row">
    <div class="pill critical">0. Q…ôrar filteri ‚Üí yalnƒ±z g√ºcl√º impulslar</div>
    <div class="pill">B√∂lm…ô 1: Futures Real Impulse (8)</div>
    <div class="pill">B√∂lm…ô 2: Spot Confirmation (4)</div>
    <div class="pill">B√∂lm…ô 3: Extra PRO (6)</div>
    <div class="pill">B√∂lm…ô 4: Market Structure (2)</div>
    <div class="pill">B√∂lm…ô 5: BTC Regime (1)</div>
  </div>

  <div class="top-bar">
    <div style="display:flex;gap:6px;flex-wrap:wrap;">
      <button id="btnResetAll" class="btn primary" type="button">Reset All</button>
      <button id="btnCopyExport" class="btn small" type="button">Copy Export</button>
    </div>
    <div class="score-bar">
      Overall Score: <span id="overallScore" class="score-value">0</span> / 21
      <span id="hfStatus" class="hf-flag hf-ok">Hard-Fail: Yox</span>
    </div>
    <div class="mode-switch">
      <button id="modeLong" class="btn small active-mode" type="button">LONG</button>
      <button id="modeShort" class="btn small" type="button">SHORT</button>
    </div>
  </div>

  <div class="sections" id="sectionsRoot">

    <!-- SECTION 0 -->
    <div class="section">
      <div class="section-header" role="button" aria-label="Collapse Section 0">
        <div class="section-title">
          üîµ 0. Q…ôrar Filteri
          <span class="badge critical">ƒ∞lk 5‚Äì10 saniy…ô</span>
        </div>
        <div class="section-score"><span class="collapse-icon">‚ñº</span></div>
      </div>
      <div class="items">
        <div style="font-size:0.72rem;color:var(--muted);line-height:1.35;">
          START siqnalƒ±ndan sonra √∂z√ºnd…ôn soru≈ü:
          <br>‚Ä¢ Bu siqnal range i√ßind…ôdir, yoxsa a√ßƒ±q impulsdadƒ±r?
          <br>‚Ä¢ Saniy…ôl…ôr i√ßind…ô > THRESHOLD h…ôr…ôk…ôt + g√ºcl√º volume var?
          <br>∆èg…ôr cavab ‚Äúbilmir…ôm‚Äùdirs…ô ‚Üí h…ôl…ô q…ôrar verm…ô, a≈üaƒüƒ±dakƒ± PRO x…ôrit…ôni doldur.
        </div>
      </div>
    </div>

    <!-- SECTION 1 -->
    <div class="section" data-section="1">
      <div class="section-header" role="button" aria-label="Collapse Section 1">
        <div class="section-title">üü¶ B√∂lm…ô 1 ‚Äî Futures REAL Impulse Check
          <span class="badge critical">∆èn vacib 8 punkt</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-1">0 / 8</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="1">
          <div class="item-title">1) Taker Buy/Sell Flow (Œî Taker)</div>
          <div class="item-desc">
            Bullish (LONG): Buy √ºst√ºn, ya≈üƒ±l spike, buy > 55‚Äì60%.<br>
            Kritik: Price ‚Üë amma buy z…ôif ‚Üí fake pump riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against / Trap</button>
          </div>
        </div>

        <div class="item" data-id="2">
          <div class="item-title">2) Basis (Futures vs Spot Premium)</div>
          <div class="item-desc">
            Bullish (LONG): Basis y√ºng√ºl ‚Üë, futures spotdan azca yuxarƒ±.<br>
            Kritik: Basis stabil / k…ôskin ‚Üë, amma price z…ôif ‚Üí manip risk.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against / Trap</button>
          </div>
        </div>

        <div class="item" data-id="3">
          <div class="item-title">3) OI / Market Cap Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Ratio stabil / y√ºng√ºl ‚Üë, leverage saƒülamdƒ±r.<br>
            Kritik: Ratio ‚Üì + Price ‚Üë ‚Üí trend yorƒüun, late long riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="4" data-hardfail="true">
          <div class="item-title">
            4) OI Dynamics ‚Äî 4 Davranƒ±≈ü
            <span class="item-hardfail-flag">HARD-FAIL</span>
          </div>
          <div class="item-desc">
            LONG konteksind…ô:<br>
            ‚ÜëOI + ‚ÜëPrice ‚Üí continuation (LONG √º√ß√ºn yax≈üƒ±)<br>
            ‚ÜëOI + ‚ÜìPrice ‚Üí SHORT trap qurulur, LONG √º√ß√ºn t…ôhl√ºk…ôlidir<br>
            ‚ÜìOI + ‚ÜëPrice ‚Üí squeeze son faza, late long riski<br>
            ‚ÜìOI + ‚ÜìPrice ‚Üí trend bitir, NO-TRADE
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports Setup</button>
            <button class="item-btn" data-score="0" type="button">Mixed</button>
            <button class="item-btn" data-score="-1" type="button">Trap / NO-TRADE</button>
          </div>
        </div>

        <div class="item" data-id="5">
          <div class="item-title">5) Notional OI</div>
          <div class="item-desc">
            Bullish (LONG): Notional + Price birlikd…ô ‚Üë ‚Üí real capital daxil olur.<br>
            Kritik: Notional stabil / ‚Üì, amma Price ‚Üë ‚Üí retail-only pump.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="6">
          <div class="item-title">6) Top Trader Account Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Retail short-heavy, pros long t…ôr…ôfd…ô.<br>
            Kritik: Retail hamƒ±sƒ± long ‚Üí FOMO, LONG √º√ß√ºn riskli zona.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad / Crowded</button>
          </div>
        </div>

        <div class="item" data-id="7">
          <div class="item-title">7) Top Trader Position Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Pros s…ônin t…ôr…ôfd…ô (long bias).<br>
            Ziddiyy…ôt varsa ‚Äî ehtiyat, position sizing-i ki√ßilt.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Pros with me</button>
            <button class="item-btn" data-score="0" type="button">Mixed</button>
            <button class="item-btn" data-score="-1" type="button">Opposite</button>
          </div>
        </div>

        <div class="item" data-id="8">
          <div class="item-title">8) Global Long/Short Ratio</div>
          <div class="item-desc">
            Bullish (LONG): Global > 1, amma ekstremal olmadan.<br>
            Bearish (LONG √º√ß√ºn): Global √ßox y√ºks…ôkdirs…ô (crowded longs) ‚Üí risk.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 2 -->
    <div class="section" data-section="2">
      <div class="section-header" role="button" aria-label="Collapse Section 2">
        <div class="section-title">
          üü© B√∂lm…ô 2 ‚Äî Spot Confirmation (4 blok)
          <span class="badge">Trend davamƒ±</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-2">0 / 4</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="9">
          <div class="item-title">BLOCK 1 ‚Äî Spot Money Flow</div>
          <div class="item-desc">
            LONG: Net inflow, real buy walls, yuxarƒ±ya doƒüru axƒ±n.<br>
            Bearish (LONG √º√ß√ºn): Net outflow, sell walls ‚Üí pump dayanƒ±qsƒ±zdƒ±r.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="10">
          <div class="item-title">BLOCK 2 ‚Äî Spot Volume</div>
          <div class="item-desc">
            LONG: Volume ‚Üë davamlƒ±, impuls arxasƒ±nda g√ºc var.<br>
            Bearish (LONG √º√ß√ºn): Volume s√∂n√ºr ‚Üí continuation z…ôifl…ôyir.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>

        <div class="item" data-id="11">
          <div class="item-title">BLOCK 3 ‚Äî Spot Orderbook</div>
          <div class="item-desc">
            LONG: A≈üaƒüƒ±da BID walls, absorption buy, alƒ±cƒ±lar d…ôst…ôkl…ôyir.<br>
            Bearish (LONG √º√ß√ºn): Yuxarƒ±da ASK walls + spoofing ‚Üí trap riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="12">
          <div class="item-title">BLOCK 4 ‚Äî Spot Price Action</div>
          <div class="item-desc">
            LONG: HH/HL ‚Üí bullish structure, continuation √º√ß√ºn saƒülam.<br>
            Bearish (LONG √º√ß√ºn): LH/LF ‚Üí reversal risk, LONG √º√ß√ºn z…ôifdir.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 3 -->
    <div class="section" data-section="3">
      <div class="section-header" role="button" aria-label="Collapse Section 3">
        <div class="section-title">
          üü™ B√∂lm…ô 3 ‚Äî Extra PRO Indicators
          <span class="badge">Detallƒ± analiz</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-3">0 / 6</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="13">
          <div class="item-title">1) CVD (Cumulative Volume Delta)</div>
          <div class="item-desc">
            LONG: CVD ‚Üë + Price ‚Üë ‚Üí real buy dominance.<br>
            Divergence (Price ‚Üë, CVD ‚Üì) ‚Üí riskli continuation.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="14">
          <div class="item-title">2) Liquidation Heatmap</div>
          <div class="item-desc">
            LONG: Yuxarƒ±da cluster ‚Üí continuation target, lakin √ßox yaxƒ±nsa trap ola bil…ôr.<br>
            A≈üaƒüƒ±da b√∂y√ºk cluster ‚Üí a≈üaƒüƒ±ya dartma riski (LONG √º√ß√ºn t…ôhl√ºk…ô).
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="15">
          <div class="item-title">3) VWAP</div>
          <div class="item-desc">
            LONG: Price > VWAP v…ô VWAP √∂z√º ‚Üë ‚Üí trend saƒülamdƒ±r.<br>
            Bearish (LONG √º√ß√ºn): Price < VWAP v…ô reject ‚Üí LONG √º√ß√ºn z…ôif zona.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="16">
          <div class="item-title">4) Tape Reading</div>
          <div class="item-desc">
            LONG: ardƒ±cƒ±l ya≈üƒ±l high-size prints, sell-l…ôr absorb olunur.<br>
            Bearish (LONG √º√ß√ºn): qƒ±rmƒ±zƒ± high-size prints, buyer-lar geri √ß…ôkilir.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>

        <div class="item" data-id="17">
          <div class="item-title">5) Funding Curve</div>
          <div class="item-desc">
            LONG: Normal / y√ºng√ºl pozitiv funding ok-dur.<br>
            Bearish (LONG √º√ß√ºn): funding k…ôskin ‚Üë + crowded longs ‚Üí trap riski.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="18">
          <div class="item-title">6) Implied Volatility (IV)</div>
          <div class="item-desc">
            LONG: IV ‚Üë + Price ‚Üë ‚Üí trend g√ºcl√º, lakin risk-liq artƒ±r.<br>
            IV ‚Üì + Price ‚Üë ‚Üí daha sakit continuation, leverage azalƒ±b.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 4 -->
    <div class="section" data-section="4">
      <div class="section-header" role="button" aria-label="Collapse Section 4">
        <div class="section-title">
          üü• B√∂lm…ô 4 ‚Äî Market Structure
          <span class="badge">4H + Local</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-4">0 / 2</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="19">
          <div class="item-title">1) 4H Macro Trend</div>
          <div class="item-desc">
            LONG: Price EMA 50/200 √ºst√ºnd…ô ‚Üí makro bullish kontekst.<br>
            Bearish (LONG √º√ß√ºn): EMA-larƒ±n altƒ±nda ‚Üí LONG √º√ß√ºn …ôks trend.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against</button>
          </div>
        </div>

        <div class="item" data-id="20">
          <div class="item-title">2) Local Structure</div>
          <div class="item-desc">
            LONG: BOS up, higher highs/lows ‚Üí continuation √º√ß√ºn yax≈üƒ±.<br>
            BOS down ‚Üí local trend …ôksin…ô, LONG √º√ß√ºn riskli zona.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Good</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Bad</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 5 -->
    <div class="section" data-section="5">
      <div class="section-header" role="button" aria-label="Collapse Section 5">
        <div class="section-title">
          üüß B√∂lm…ô 5 ‚Äî BTC Regime
          <span class="badge">Altcoin Must</span>
        </div>
        <div class="section-score">
          Score: <span class="score-value" id="score-sec-5">0 / 1</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
      </div>

      <div class="items">
        <div class="item" data-id="21" data-hardfail="true">
          <div class="item-title">
            BTC Mood (OI, VWAP, Liquidity)
            <span class="item-hardfail-flag">HARD-FAIL</span>
          </div>
          <div class="item-desc">
            LONG: BTC OI ‚Üë + Price ‚Üë, VWAP √ºst√º ‚Üí altcoin LONG √º√ß√ºn saƒülam fon.<br>
            Bearish (LONG √º√ß√ºn): OI ‚Üë + Price ‚Üì ‚Üí BTC-d…ô trap / risk rejimi, NO-TRADE.
          </div>
          <div class="item-actions">
            <button class="item-btn" data-score="1" type="button">Supports</button>
            <button class="item-btn" data-score="0" type="button">Neutral</button>
            <button class="item-btn" data-score="-1" type="button">Against / NO-TRADE</button>
          </div>
        </div>
      </div>
    </div>

    <!-- FINAL CARD -->
    <div class="final-card">
      <div class="final-title">üöÄ Final Decision Map</div>

      <div class="final-score-line">
        Overall Score: <span id="finalScoreText" class="score-value">0 / 21</span>
      </div>

      <div id="finalVerdict" class="final-verdict">Status: No data</div>
      <div id="finalComment" class="final-note">Checklist-i doldur, n…ôtic…ô burada real-time yenil…ôn…ôc…ôk.</div>

      <div class="export-box">
        <div class="export-label">Telegram √º√ß√ºn Export:</div>
        <textarea id="exportText" readonly></textarea>
      </div>

      <div class="export-box">
        <div class="export-label">Local Trade Log (yalnƒ±z bu cihazda saxlanƒ±lƒ±r):</div>
        <div class="trade-log-inputs">
          <input id="logSymbol" placeholder="Pair (m…ôs: BTCUSDT)" />
          <input id="logTF" placeholder="TF (m…ôs: 5m / 15m)" />
        </div>
        <button id="btnSaveTrade" class="btn small" type="button">Bu setup-ƒ± Log et</button>

        <div style="display:flex;gap:4px;margin-top:4px;flex-wrap:wrap;">
          <button id="btnExportJson" class="btn small" type="button">Export JSON</button>
          <button id="btnImportJson" class="btn small" type="button">Import JSON</button>
        </div>

        <input id="importFile" type="file" accept="application/json,text/*" style="display:none" />
        <div id="tradeLogList" class="trade-log-list"></div>
      </div>

      <div class="export-box">
        <div class="export-label">Session Comparison (V2.1) ‚Äî 2 f…ôrqli setup-ƒ± yan-yana m√ºqayis…ô et:</div>
        <div class="trade-log-inputs">
          <select id="sessionA"></select>
          <select id="sessionB"></select>
        </div>
        <button id="btnCompareSessions" class="btn small" type="button">Compare Sessions</button>
        <div id="sessionCompareResult" class="trade-log-list" style="margin-top:4px;"></div>
      </div>
    </div>

  </div>
</div>

<!-- Offline update toast -->
<div id="updateToast" class="update-toast" aria-live="polite">
  <div class="update-toast-text" id="updateToastText">Yeni versiya m√∂vcuddur ‚Äî yenil…ôm…ôk ist…ôyirs…ôn?</div>
  <div class="update-toast-actions">
    <button id="updateRefreshBtn" class="btn primary small" type="button">Refresh</button>
    <button id="updateDismissBtn" class="btn small" type="button">Sonra</button>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ===========================
  // CONSTANTS (LocalStorage)
  // ===========================
  const STORAGE_KEY_STATE = "proTrendV2_state";
  const STORAGE_KEY_LOG   = "proTrendV2_trades";

  const SECTION_MAX = { 1: 8, 2: 4, 3: 6, 4: 2, 5: 1 };
  const SECTION_NAME = {
    1: "Futures Impulse",
    2: "Spot Confirmation",
    3: "Extra PRO",
    4: "Market Structure",
    5: "BTC Regime"
  };

  // Mode state
  let currentMode = "LONG";
  const itemTexts = {}; // long base texts
  let tradeLog = [];

  let lastTotals = {
    total: 0,
    secScores: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 },
    hardFail: false,
    verdict: "Status: No data"
  };

  // SHORT mode texts (only overrides)
  const shortModeConfig = {
    1: { title: "1) Taker Buy/Sell Flow (Œî Taker) ‚Äî SHORT",
      desc: "Bearish (SHORT): Sell √ºst√ºn, qƒ±rmƒ±zƒ± spike, sell > 55‚Äì60%.<br>Kritik: Price ‚Üì amma sell z…ôif ‚Üí fake dump / short trap riski." },
    2: { title: "2) Basis (Futures vs Spot Premium) ‚Äî SHORT",
      desc: "Bearish (SHORT): Basis y√ºng√ºl ‚Üì v…ô ya m…ônfi, futures spotdan a≈üaƒüƒ±.<br>Kritik: Basis k…ôskin ‚Üë + Price ‚Üì ‚Üí crowded shorts, squeeze riski." },
    3: { title: "3) OI / Market Cap Ratio ‚Äî SHORT",
      desc: "Bearish (SHORT): Ratio ‚Üë v…ô Price ‚Üì ‚Üí leveraged short trend g√ºcl√ºd√ºr.<br>Kritik: Ratio ‚Üì + Price ‚Üì ‚Üí trend yorƒüun, late short riski." },
    4: { title: "4) OI Dynamics ‚Äî 4 Davranƒ±≈ü (SHORT)",
      desc: "SHORT konteksind…ô:<br>‚ÜëOI + ‚ÜìPrice ‚Üí continuation (SHORT √º√ß√ºn yax≈üƒ±)<br>‚ÜëOI + ‚ÜëPrice ‚Üí short squeeze / trap riski<br>‚ÜìOI + ‚ÜìPrice ‚Üí son faza, daha √ßox profit-taking<br>‚ÜìOI + ‚ÜëPrice ‚Üí squeeze, yeni short √º√ß√ºn √ßox risklidir." },
    5: { title: "5) Notional OI ‚Äî SHORT",
      desc: "Bearish (SHORT): Notional stabil / y√ºng√ºl ‚Üë, Price ‚Üì ‚Üí short t…ôr…ôfi aktivdir.<br>Kritik: Notional ‚Üì + Price ‚Üì ‚Üí de-leverage son faza, late short." },
    6: { title: "6) Top Trader Account Ratio ‚Äî SHORT",
      desc: "SHORT: Retail long-heavydirs…ô, pros short t…ôr…ôfd…ô ‚Üí √ºst√ºnl√ºk.<br>Kritik: Retail hamƒ±sƒ± short ‚Üí squeeze riski." },
    7: { title: "7) Top Trader Position Ratio ‚Äî SHORT",
      desc: "SHORT: Pros short bias-dadƒ±rsa, setup daha etibarlƒ±dƒ±r.<br>∆èksin…ôdirs…ô, short √º√ß√ºn ehtiyat." },
    8: { title: "8) Global Long/Short Ratio ‚Äî SHORT",
      desc: "SHORT: Global > 1 (crowded longs) ‚Üí short √º√ß√ºn r√ºzgar s…ônin t…ôr…ôfind…ôdir.<br>Global < 1 v…ô hamƒ± shortdadƒ±rsa ‚Üí squeeze riski." },
    9: { title: "BLOCK 1 ‚Äî Spot Money Flow (SHORT)",
      desc: "SHORT: Net outflow, sell walls, yuxarƒ±da sell interest ‚Üí dump davam ed…ô bil…ôr.<br>Against (SHORT √º√ß√ºn): Net inflow + buy walls ‚Üí short √º√ß√ºn t…ôhl√ºk…ô." },
    10:{ title: "BLOCK 2 ‚Äî Spot Volume (SHORT)",
      desc: "SHORT: A≈üaƒüƒ±ya doƒüru impulsda sell volume ‚Üë davamlƒ±.<br>Kritik: Volume s√∂n√ºrs…ô, dump g√ºc√ºn√º itirir, late short riski." },
    11:{ title: "BLOCK 3 ‚Äî Spot Orderbook (SHORT)",
      desc: "SHORT: Yuxarƒ±da ASK walls, sell absorption, h…ôr pump satƒ±lƒ±r.<br>Against: A≈üaƒüƒ±da g√ºcl√º BID walls ‚Üí short √º√ß√ºn risk." },
    12:{ title: "BLOCK 4 ‚Äî Spot Price Action (SHORT)",
      desc: "SHORT: LH/LF, lower highs/lows ‚Üí bearish structure, continuation √º√ß√ºn yax≈üƒ±.<br>Against: HH/HL ‚Üí short-a qar≈üƒ± trend." },
    14:{ title: "2) Liquidation Heatmap (SHORT)",
      desc: "SHORT: A≈üaƒüƒ±da likvidation cluster-lar target kimidir, amma √ßox yaxƒ±nsa immediate bounce riski var.<br>Yuxarƒ±dakƒ± b√∂y√ºk cluster-lar squeeze √º√ß√ºn maqnit ola bil…ôr." },
    15:{ title: "3) VWAP (SHORT)",
      desc: "SHORT: Price < VWAP v…ô VWAP a≈üaƒüƒ± meyillidirs…ô ‚Üí trend short t…ôr…ôfd…ôdir.<br>Against: Price > VWAP v…ô h…ôr d…ôf…ô √ºst√ºnd…ô qalƒ±rsa ‚Üí short √º√ß√ºn z…ôifdir." },
    17:{ title: "5) Funding Curve (SHORT)",
      desc: "SHORT: Funding √ßox pozitiv + crowded longs ‚Üí short √º√ß√ºn advantage.<br>Against: Funding artƒ±q negativ, amma Price h…ôl…ô d…ô a≈üaƒüƒ±dƒ±rsa ‚Üí late short riski." },
    18:{ title: "6) Implied Volatility (IV) ‚Äî SHORT",
      desc: "SHORT: IV √ßox y√ºks…ôk + Price a≈üaƒüƒ± ‚Üí qƒ±sa m√ºdd…ôtlik continuation, amma agressiv squeeze riski d…ô artƒ±r.<br>IV d√º≈üm…ôy…ô ba≈ülayƒ±rsa ‚Üí artƒ±q de-risking gedir, late short ola bil…ôr." },
    19:{ title: "1) 4H Macro Trend ‚Äî SHORT",
      desc: "SHORT: Price EMA 50/200 altƒ±nda ‚Üí makro bearish kontekst, short √º√ß√ºn uyƒüundur.<br>Against: EMA-larƒ±n √ºst√ºnd…ô ‚Üí short √º√ß√ºn …ôks trend." },
    20:{ title: "2) Local Structure ‚Äî SHORT",
      desc: "SHORT: BOS down, lower lows/highs ‚Üí continuation √º√ß√ºn yax≈üƒ±.<br>BOS up ‚Üí short-a qar≈üƒ± local reversal." },
    21:{ title: "BTC Mood (OI, VWAP, Liquidity) ‚Äî SHORT",
      desc: "SHORT: BTC OI ‚Üë + Price ‚Üì, VWAP altƒ±nda ‚Üí altcoin SHORT √º√ß√ºn saƒülam fon.<br>Against: OI ‚Üë + Price ‚Üë ‚Üí BTC-d…ô squeeze rejimi, NO-TRADE." }
  };

  // ===========================
  // DOM
  // ===========================
  const $ = (id) => document.getElementById(id);

  const sectionsRoot = $("sectionsRoot");
  const overallScoreEl = $("overallScore");
  const finalScoreTextEl = $("finalScoreText");
  const finalVerdictEl = $("finalVerdict");
  const finalCommentEl = $("finalComment");
  const hfStatusEl = $("hfStatus");
  const exportTextEl = $("exportText");

  const btnResetAll = $("btnResetAll");
  const btnCopyExport = $("btnCopyExport");
  const btnSaveTrade = $("btnSaveTrade");
  const btnExportJson = $("btnExportJson");
  const btnImportJson = $("btnImportJson");
  const btnCompareSessions = $("btnCompareSessions");

  const modeLongBtn = $("modeLong");
  const modeShortBtn = $("modeShort");

  // Update toast
  const updateToast = $("updateToast");
  const updateRefreshBtn = $("updateRefreshBtn");
  const updateDismissBtn = $("updateDismissBtn");
  let waitingSW = null;

  // ===========================
  // Helpers
  // ===========================
  function sectionMax(id) { return SECTION_MAX[id] || 0; }

  function buildVerdict(total, hardFail) {
    if (hardFail) {
      return {
        verdict: "‚ùå HARD-FAIL ‚Äî NO TRADE",
        comment: "BTC v…ô ya OI Dynamics ciddi …ôleyhd…ôdir. Score y√ºks…ôk olsa bel…ô TREYD ETM∆è. Trap riskini q…ôbul etm…ô."
      };
    }
    if (total >= 13) {
      return {
        verdict: "‚úÖ HIGH CONVICTION ‚Äî PRO Entry",
        comment: "Futures + Spot + Extra PRO + Struktur + BTC hamƒ±sƒ± s…ônin t…ôr…ôfind…ôdir. Planlƒ± riskl…ô PRO √∂l√ß√ºd…ô entry m√ºmk√ºnd√ºr."
      };
    }
    if (total >= 7) {
      return {
        verdict: "üü¢ STRONG / OK Setup",
        comment: "∆èsas bloklar alignment verir. Normal √∂l√ß√ºd…ô trade edil…ô bil…ôr, z…ôif bloklarƒ± risk hesablamasƒ±nda n…ôz…ôr…ô al."
      };
    }
    if (total >= 3) {
      return {
        verdict: "üü° MIXED ‚Äî Small Size / Scout",
        comment: "B…ôzi bloklar yax≈üƒ±, b…ôzil…ôri …ôleyhin…ôdir. Bu daha √ßox scout-size v…ô praktik m√º≈üahid…ô treydi √º√ß√ºnd√ºr."
      };
    }
    if (total >= 0) {
      return {
        verdict: "üüß WEAK ‚Äî NO-TRADE Zone",
        comment: "Alignment √ßox z…ôifdir. Daha t…ômiz impuls v…ô daha g√ºcl√º t…ôsdiq √º√ß√ºn s…ôbr etm…ôk uzun m√ºdd…ôtd…ô daha s…ôrf…ôlidir."
      };
    }
    return {
      verdict: "üî¥ CONTRARIAN ONLY",
      comment: "√úmumi skor m…ônfidir. Bu yalnƒ±z √ßox t…ôcr√ºb…ôli kontrarian scalp √º√ß√ºn m…ôntiqlidir, normal treyd √º√ß√ºn uyƒüun deyil."
    };
  }

  function buildExport(secScores, total, verdict, hardFail) {
    let text = "";
    text += "üìå PRO Trend Verification ‚Äî FULL MODE V2.1\n";
    text += `Mode: ${currentMode}\n`;
    text += "----------------------------------------\n";
    text += `üü¶ Futures Impulse: ${secScores[1]} / 8\n`;
    text += `üü© Spot Confirmation: ${secScores[2]} / 4\n`;
    text += `üü™ Extra PRO: ${secScores[3]} / 6\n`;
    text += `üü• Market Structure: ${secScores[4]} / 2\n`;
    text += `üüß BTC Regime: ${secScores[5]} / 1\n\n`;
    text += `üìä Overall Score: ${total} / 21\n`;
    text += `‚öôÔ∏è Hard-Fail: ${hardFail ? "VAR (NO-TRADE)" : "Yox"}\n`;
    text += `üßæ Verdict: ${verdict}\n`;
    exportTextEl.value = text;
  }

  function formatTimestamp(ts) {
    try {
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    } catch (e) {
      return String(ts || "");
    }
  }

  // ===========================
  // Mode text system
  // ===========================
  function initModeTexts() {
    document.querySelectorAll(".item").forEach((item) => {
      const id = item.dataset.id;
      if (!id) return;
      const tEl = item.querySelector(".item-title");
      const dEl = item.querySelector(".item-desc");
      if (!tEl || !dEl) return;
      if (!itemTexts[id]) {
        itemTexts[id] = { titleLong: tEl.innerHTML, descLong: dEl.innerHTML };
      }
    });
  }

  function applyModeToItems() {
    document.querySelectorAll(".item").forEach((item) => {
      const id = item.dataset.id;
      if (!id) return;
      const tEl = item.querySelector(".item-title");
      const dEl = item.querySelector(".item-desc");
      if (!tEl || !dEl) return;

      const base = itemTexts[id];
      if (currentMode === "LONG") {
        if (base) { tEl.innerHTML = base.titleLong; dEl.innerHTML = base.descLong; }
      } else {
        const cfg = shortModeConfig[id] || {};
        tEl.innerHTML = cfg.title || (base && base.titleLong) || tEl.innerHTML;
        dEl.innerHTML = cfg.desc || (base && base.descLong) || dEl.innerHTML;
      }
    });
  }

  function setMode(mode) {
    currentMode = (mode === "SHORT") ? "SHORT" : "LONG";
    modeLongBtn.classList.toggle("active-mode", currentMode === "LONG");
    modeShortBtn.classList.toggle("active-mode", currentMode === "SHORT");
    applyModeToItems();
    recompute();
    saveStateToStorage();
  }

  // ===========================
  // Scoring logic (delegated)
  // ===========================
  function setScoreForItem(itemEl, score) {
    if (!itemEl) return;
    itemEl.dataset.score = String(score);

    const buttons = itemEl.querySelectorAll(".item-btn");
    buttons.forEach((b) => b.classList.remove("active-support", "active-neutral", "active-against"));

    // which button pressed? we match by data-score
    const pressed = itemEl.querySelector(`.item-btn[data-score="${score}"]`);
    if (score === 1 && pressed) pressed.classList.add("active-support");
    else if (score === 0 && pressed) pressed.classList.add("active-neutral");
    else if (score === -1 && pressed) pressed.classList.add("active-against");

    recompute();
    saveStateToStorage();
  }

  function recompute() {
    const secScores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let total = 0;
    let hardFail = false;

    // Sum per section
    document.querySelectorAll(".section[data-section]").forEach((sec) => {
      const sid = parseInt(sec.dataset.section || "0", 10);
      if (!sid) return;

      let sum = 0;
      sec.querySelectorAll(".item").forEach((item) => {
        const s = parseInt(item.dataset.score || "0", 10);
        sum += s;

        // Hardfail triggers only if marked hardfail AND score is -1
        if (item.dataset.hardfail === "true" && s === -1) hardFail = true;
      });

      const max = sectionMax(sid);
      // Clamp: negative values don't reduce section score below 0 for display,
      // BUT they DO affect total logic? In your original logic total was overall alignment:
      // We'll keep total as sum of clamped positives to match your "0..21" scoreboard.
      const clamped = Math.max(0, Math.min(max, sum));
      secScores[sid] = clamped;
    });

    total = secScores[1] + secScores[2] + secScores[3] + secScores[4] + secScores[5];

    // Update section score UI
    for (let i = 1; i <= 5; i++) {
      const el = $("score-sec-" + i);
      if (el) el.textContent = `${secScores[i]} / ${SECTION_MAX[i]}`;
    }

    // Verdict
    const v = buildVerdict(total, hardFail);

    lastTotals = {
      total,
      secScores: { ...secScores },
      hardFail,
      verdict: v.verdict
    };

    // Update UI
    overallScoreEl.textContent = String(total);
    finalScoreTextEl.textContent = `${total} / 21`;
    finalVerdictEl.textContent = v.verdict;
    finalCommentEl.textContent = v.comment;

    hfStatusEl.textContent = `Hard-Fail: ${hardFail ? "VAR (NO-TRADE)" : "Yox"}`;
    hfStatusEl.classList.toggle("hf-ok", !hardFail);
    hfStatusEl.classList.toggle("hf-bad", hardFail);

    // Export
    buildExport(secScores, total, v.verdict, hardFail);
  }

  // ===========================
  // LocalStorage state
  // ===========================
  function saveStateToStorage() {
    try {
      const scores = {};
      document.querySelectorAll(".item").forEach((item) => {
        const id = item.dataset.id;
        if (!id) return;
        scores[id] = parseInt(item.dataset.score || "0", 10);
      });
      const payload = { version: 1, mode: currentMode, scores };
      localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(payload));
    } catch (e) {}
  }

  function loadStateFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_STATE);
      if (!raw) return null;
      return JSON.parse(raw);
    } catch (e) {
      return null;
    }
  }

  function applySavedScores(scores) {
    if (!scores) return;
    document.querySelectorAll(".item").forEach((item) => {
      const id = item.dataset.id;
      if (!id) return;
      if (!(id in scores)) return;

      const s = parseInt(scores[id], 10);
      item.dataset.score = String(s);

      const buttons = item.querySelectorAll(".item-btn");
      buttons.forEach((b) => b.classList.remove("active-support", "active-neutral", "active-against"));

      const pressed = item.querySelector(`.item-btn[data-score="${s}"]`);
      if (s === 1 && pressed) pressed.classList.add("active-support");
      else if (s === 0 && pressed) pressed.classList.add("active-neutral");
      else if (s === -1 && pressed) pressed.classList.add("active-against");
    });
  }

  // ===========================
  // Reset & Copy
  // ===========================
  function resetAll() {
    document.querySelectorAll(".item").forEach((item) => {
      delete item.dataset.score;
      const buttons = item.querySelectorAll(".item-btn");
      buttons.forEach((b) => b.classList.remove("active-support", "active-neutral", "active-against"));
    });
    recompute();
    saveStateToStorage();
  }

  async function copyExport() {
    try {
      const txt = exportTextEl.value || "";
      if (!txt.trim()) { alert("Export bo≈üdur."); return; }

      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(txt);
      } else {
        exportTextEl.focus();
        exportTextEl.select();
        document.execCommand("copy");
      }
      alert("Export kopyalandƒ± ‚úî");
    } catch (e) {
      alert("Copy alƒ±nmadƒ±. (iOS/PWA icaz…ô m…ôhdudiyy…ôti ola bil…ôr)");
    }
  }

  // ===========================
  // Trade log
  // ===========================
  function saveTradeLogToStorage() {
    try { localStorage.setItem(STORAGE_KEY_LOG, JSON.stringify(tradeLog)); } catch (e) {}
  }

  function loadTradeLog() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY_LOG);
      tradeLog = raw ? (JSON.parse(raw) || []) : [];
    } catch (e) {
      tradeLog = [];
    }
    renderTradeLog();
    updateSessionSelectors();
  }

  function renderTradeLog() {
    const box = $("tradeLogList");
    if (!box) return;

    if (!tradeLog || tradeLog.length === 0) {
      box.innerHTML = '<div style="color: var(--muted); font-size:0.68rem;">H…ôl…ô he√ß bir trade log edilm…ôyib.</div>';
      return;
    }

    let html = "";
    tradeLog.slice().reverse().forEach((entry) => {
      html += `<div class="trade-log-entry">
        <div class="trade-log-entry-header">[${formatTimestamp(entry.ts)}] ${entry.symbol || "N/A"} ${entry.tf ? "(" + entry.tf + ")" : ""}</div>
        <div class="trade-log-entry-meta">Mode: ${entry.mode} ‚Äî Score: ${entry.totalScore} / 21, Hard-Fail: ${entry.hardFail ? "VAR" : "Yox"}</div>
        <div class="trade-log-entry-meta">Verdict: ${entry.verdict || "-"}</div>
      </div>`;
    });

    box.innerHTML = html;
  }

  function saveTradeLog() {
    const symbol = ($("logSymbol").value || "").trim();
    const tf = ($("logTF").value || "").trim();

    if (!symbol) { alert("Trade log √º√ß√ºn …ôn azƒ± pair (m…ôs: BTCUSDT) yaz."); return; }

    const anyScored = !!document.querySelector(".item[data-score]");
    if (!anyScored) { alert("∆èvv…ôlc…ô checklist-d…ôn …ôn azƒ± bir ne√ß…ô punkt i≈üar…ôl…ô, sonra log et."); return; }

    const entry = {
      ts: new Date().toISOString(),
      mode: currentMode,
      symbol,
      tf,
      totalScore: lastTotals.total,
      secScores: lastTotals.secScores,
      hardFail: lastTotals.hardFail,
      verdict: lastTotals.verdict
    };

    tradeLog.push(entry);
    if (tradeLog.length > 200) tradeLog = tradeLog.slice(tradeLog.length - 200);

    saveTradeLogToStorage();
    renderTradeLog();
    updateSessionSelectors();

    $("logTF").value = "";
  }

  // ===========================
  // JSON export/import
  // ===========================
  function exportJournalJson() {
    try {
      const scores = {};
      document.querySelectorAll(".item").forEach((item) => {
        const id = item.dataset.id;
        if (!id) return;
        scores[id] = parseInt(item.dataset.score || "0", 10);
      });

      const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        mode: currentMode,
        totals: lastTotals,
        scores,
        tradeLog: tradeLog || []
      };

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const d = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");

      a.href = url;
      a.download = `pro_trend_journal_${y}${m}${d}_${hh}${mm}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);
      alert("Journal JSON formatƒ±nda export olundu ‚úî");
    } catch (e) {
      alert("Export zamanƒ± x…ôta ba≈ü verdi.");
    }
  }

  function importJournalJson() {
    const fileInput = $("importFile");
    if (!fileInput) return;

    fileInput.value = "";
    fileInput.onchange = (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data || typeof data !== "object") throw new Error("Bad JSON");

          if (data.mode === "SHORT" || data.mode === "LONG") setMode(data.mode);
          if (data.scores && typeof data.scores === "object") applySavedScores(data.scores);

          if (Array.isArray(data.tradeLog)) {
            tradeLog = data.tradeLog;
            saveTradeLogToStorage();
          }

          recompute();
          saveStateToStorage();
          renderTradeLog();
          updateSessionSelectors();

          alert("Journal JSON-dan uƒüurla import olundu ‚úî");
        } catch (err) {
          console.error(err);
          alert("JSON faylƒ± d√ºzg√ºn formatda deyil.");
        }
      };
      reader.readAsText(file);
    };

    fileInput.click();
  }

  // ===========================
  // Session comparison (V2.1)
  // ===========================
  function updateSessionSelectors() {
    const selA = $("sessionA");
    const selB = $("sessionB");
    const resBox = $("sessionCompareResult");
    if (!selA || !selB || !resBox) return;

    selA.innerHTML = "";
    selB.innerHTML = "";

    if (!tradeLog || tradeLog.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No sessions logged";
      selA.appendChild(opt.cloneNode(true));
      selB.appendChild(opt);
      selA.disabled = true;
      selB.disabled = true;
      resBox.innerHTML = '<div style="color: var(--muted); font-size:0.68rem;">M√ºqayis…ô √º√ß√ºn …ôvv…ôlc…ô …ôn azƒ± 2 trade log et.</div>';
      return;
    }

    selA.disabled = false;
    selB.disabled = false;

    tradeLog.forEach((entry, idx) => {
      const label = `[${formatTimestamp(entry.ts)}] ${entry.symbol || "N/A"} ${entry.tf ? "(" + entry.tf + ")" : ""} ‚Äî ${entry.mode} ${entry.totalScore != null ? " | " + entry.totalScore + "/21" : ""}`;

      const optA = document.createElement("option");
      optA.value = String(idx);
      optA.textContent = label;

      const optB = document.createElement("option");
      optB.value = String(idx);
      optB.textContent = label;

      selA.appendChild(optA);
      selB.appendChild(optB);
    });

    const n = tradeLog.length;
    if (n >= 1) selB.value = String(n - 1);
    if (n >= 2) selA.value = String(n - 2);
    else selA.value = String(0);
  }

  function compareSessions() {
    const selA = $("sessionA");
    const selB = $("sessionB");
    const resBox = $("sessionCompareResult");
    if (!selA || !selB || !resBox) return;

    const idxA = parseInt(selA.value || "-1", 10);
    const idxB = parseInt(selB.value || "-1", 10);

    if (isNaN(idxA) || isNaN(idxB) || idxA < 0 || idxB < 0 || idxA >= tradeLog.length || idxB >= tradeLog.length) {
      alert("M√ºqayis…ô √º√ß√ºn 2 ke√ß…ôrli sessiya se√ß.");
      return;
    }
    if (idxA === idxB) {
      alert("Eyni sessiyanƒ± √∂z-√∂z√º il…ô m√ºqayis…ô etm…ôk m…ôna vermir, f…ôrqli 2 sessiya se√ß.");
      return;
    }

    const A = tradeLog[idxA];
    const B = tradeLog[idxB];

    const scoresA = A.secScores || {};
    const scoresB = B.secScores || {};

    let html = "";

    html += `<div class="trade-log-entry">
      <div class="trade-log-entry-header">Session A</div>
      <div class="trade-log-entry-meta">[${formatTimestamp(A.ts)}] ${A.symbol || "N/A"} ${A.tf ? "(" + A.tf + ")" : ""} ‚Äî Mode: ${A.mode}</div>
      <div class="trade-log-entry-meta">Score: ${A.totalScore ?? 0} / 21, Hard-Fail: ${A.hardFail ? "VAR" : "Yox"}</div>
      <div class="trade-log-entry-meta">Verdict: ${A.verdict || "-"}</div>
    </div>`;

    html += `<div class="trade-log-entry">
      <div class="trade-log-entry-header">Session B</div>
      <div class="trade-log-entry-meta">[${formatTimestamp(B.ts)}] ${B.symbol || "N/A"} ${B.tf ? "(" + B.tf + ")" : ""} ‚Äî Mode: ${B.mode}</div>
      <div class="trade-log-entry-meta">Score: ${B.totalScore ?? 0} / 21, Hard-Fail: ${B.hardFail ? "VAR" : "Yox"}</div>
      <div class="trade-log-entry-meta">Verdict: ${B.verdict || "-"}</div>
    </div>`;

    // per section comparison
    let maxAbsDiff = -1;
    let maxDiffSec = null;

    let consistencySum = 0;
    let consistencyCount = 0;

    html += `<div class="trade-log-entry">
      <div class="trade-log-entry-header">Section-by-Section</div>`;

    for (let i = 1; i <= 5; i++) {
      const sa = parseInt(scoresA[i] || 0, 10);
      const sb = parseInt(scoresB[i] || 0, 10);
      const diff = sb - sa;
      const absDiff = Math.abs(diff);
      const maxVal = SECTION_MAX[i] || 1;

      const consistency = Math.max(0, 1 - absDiff / maxVal);
      consistencySum += consistency;
      consistencyCount++;

      if (absDiff > maxAbsDiff) {
        maxAbsDiff = absDiff;
        maxDiffSec = i;
      }

      html += `<div class="trade-log-entry-meta">
        ‚Ä¢ ${SECTION_NAME[i]}: A ${sa}/${maxVal} ‚Üí B ${sb}/${maxVal} (Œî ${diff > 0 ? "+" + diff : diff})
      </div>`;
    }

    const consistencyPct = consistencyCount ? Math.round((consistencySum / consistencyCount) * 100) : 0;
    const focus = maxDiffSec ? `${SECTION_NAME[maxDiffSec]} (…ôn b√∂y√ºk f…ôrq)` : "-";

    html += `<div class="trade-log-entry-meta" style="margin-top:6px;">
      Consistency: <span style="color: var(--accent); font-weight:700;">${consistencyPct}%</span><br>
      Focus: <span style="color: var(--accent); font-weight:700;">${focus}</span>
    </div>`;
    html += `</div>`;

    resBox.innerHTML = html;
  }

  // ===========================
  // Section collapse (safe)
  // ===========================
  function initCollapse() {
    document.querySelectorAll(".section-header").forEach((h) => {
      h.addEventListener("click", (e) => {
        // button klikind…ô collapse etm…ô
        if (e.target.closest("button")) return;
        const sec = h.closest(".section");
        if (!sec) return;
        sec.classList.toggle("collapsed");
      }, { passive: true });
    });

    // Default: only Section 1 open
    document.querySelectorAll(".section[data-section]").forEach((sec) => {
      const id = parseInt(sec.dataset.section || "0", 10);
      if (id > 1) sec.classList.add("collapsed");
    });
  }

  // ===========================
  // Delegated tap/click handler (iOS 26 stable)
  // ===========================
  function initDelegatedButtons() {
    const handler = (e) => {
      const btn = e.target.closest(".item-btn");
      if (!btn) return;
      const item = btn.closest(".item");
      if (!item) return;
      const score = parseInt(btn.dataset.score || "0", 10);
      setScoreForItem(item, score);
    };

    // pointerup primary
    sectionsRoot.addEventListener("pointerup", handler, { passive: true });
    // click fallback (desktop / older)
    sectionsRoot.addEventListener("click", handler, { passive: true });
  }

  // ===========================
  // Service worker update toast
  // ===========================
  function showUpdateToast() {
    if (!updateToast) return;
    updateToast.style.display = "flex";
  }
  function hideUpdateToast() {
    if (!updateToast) return;
    updateToast.style.display = "none";
  }

  async function registerServiceWorker() {
    if (!("serviceWorker" in navigator)) return;

    try {
      const reg = await navigator.serviceWorker.register("./service-worker.js", { scope: "./" });

      // If already waiting (rare)
      if (reg.waiting) {
        waitingSW = reg.waiting;
        showUpdateToast();
      }

      reg.addEventListener("updatefound", () => {
        const newWorker = reg.installing;
        if (!newWorker) return;

        newWorker.addEventListener("statechange", () => {
          if (newWorker.state === "installed") {
            // If there is a controller, it means update available
            if (navigator.serviceWorker.controller) {
              waitingSW = reg.waiting || newWorker;
              showUpdateToast();
            }
          }
        });
      });

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        // New SW activated => reload
        window.location.reload();
      });
    } catch (e) {
      // SW register fail: ignore
    }
  }

  function wireTopButtons() {
    btnResetAll.addEventListener("click", resetAll);
    btnCopyExport.addEventListener("click", copyExport);

    modeLongBtn.addEventListener("click", () => setMode("LONG"));
    modeShortBtn.addEventListener("click", () => setMode("SHORT"));

    btnSaveTrade.addEventListener("click", saveTradeLog);
    btnExportJson.addEventListener("click", exportJournalJson);
    btnImportJson.addEventListener("click", importJournalJson);
    btnCompareSessions.addEventListener("click", compareSessions);

    updateRefreshBtn.addEventListener("click", () => {
      try {
        if (waitingSW) waitingSW.postMessage({ type: "SKIP_WAITING" });
      } catch (e) {}
      hideUpdateToast();
    });

    updateDismissBtn.addEventListener("click", () => hideUpdateToast());
  }

  // ===========================
  // Boot
  // ===========================
  function boot() {
    initCollapse();
    initModeTexts();
    initDelegatedButtons();
    wireTopButtons();

    // Load saved state
    const state = loadStateFromStorage();
    if (state && (state.mode === "LONG" || state.mode === "SHORT")) {
      currentMode = state.mode;
    }
    applyModeToItems();

    if (state && state.scores) applySavedScores(state.scores);

    // Load log
    loadTradeLog();

    // Mode UI
    modeLongBtn.classList.toggle("active-mode", currentMode === "LONG");
    modeShortBtn.classList.toggle("active-mode", currentMode === "SHORT");

    recompute();
    registerServiceWorker();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot, { once: true });
  } else {
    boot();
  }

})();
</script>
</body>
</html>
